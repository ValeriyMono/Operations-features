function onOpen() {
  const ui = SpreadsheetApp.getUi();
  const menu = ui.createMenu('ВГХ Заповнення');
  menu
    .addItem('Вставити МІН значення', 'runFillMin')
    .addItem('Вставити СЕРЕДНЄ значення', 'runFillAvg')
    .addItem('Вставити МАКС значення', 'runFillMax')
    .addToUi();
}

function runFillMin() {
  fillDimensionsByCategory('min');
}

function runFillAvg() {
  fillDimensionsByCategory('avg');
}

function runFillMax() {
  fillDimensionsByCategory('max');
}

function fillDimensionsByCategory(choice) {
  const typeIndex = { min: 0, avg: 1, max: 2 }[choice];

  if (typeIndex === undefined) {
    SpreadsheetApp.getUi().alert('Некоректне значення. Введіть: min, avg або max.');
    return;
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sourceSheet = ss.getSheetByName('Додавання ВГХ');
  const assetsSheet = ss.getSheetByName('Assets');
  const resultsSheet = ss.getSheetByName('Results');

  const sourceData = sourceSheet.getDataRange().getValues();
  const headers = sourceData[0];
  const rows = sourceData.slice(1);

  const assetsData = assetsSheet.getDataRange().getValues().slice(1);

  const categoryIndex = headers.indexOf('categories');
  const paramIndexes = {
    full_weight: headers.indexOf('full_weight'),
    package_height: headers.indexOf('package_height'),
    package_length: headers.indexOf('package_length'),
    package_width: headers.indexOf('package_width'),
  };

  let filledCount = 0;
  const missingCategories = new Set();

  const assetMap = {};
  for (const [cat, param, min, avg, max] of assetsData) {
    if (!assetMap[cat]) assetMap[cat] = {};
    assetMap[cat][param] = [min, avg, max];
  }

  const updatedValues = [];
  const backgrounds = [];

  const protectedFields = new Set([
    'uuid', 'sku', 'categories', 'variation_name', 'code', 'partner_name', 'vendor_code', 'offer', 'barcode'
  ]);

  const protectedIndexes = headers
    .map((header, idx) => protectedFields.has(header) ? idx : -1)
    .filter(index => index !== -1);

  rows.forEach((row, i) => {
    const cat = row[categoryIndex];
    const newRow = [...row];
    const newBgRow = new Array(row.length).fill(null);
    let rowChanged = false;

    if (!cat) return;
    if (!assetMap[cat]) {
      missingCategories.add(cat);
      return;
    }

    for (const param in paramIndexes) {
      const colIndex = paramIndexes[param];
      if (row[colIndex] === '' || row[colIndex] === null) {
        const valueSet = assetMap[cat][param];
        if (valueSet && valueSet[typeIndex] !== undefined) {
          newRow[colIndex] = valueSet[typeIndex];
          newBgRow[colIndex] = '#d0f0c0';
          filledCount++;
          rowChanged = true;
        }
      }
    }

    // Preserve raw values for protected fields
    protectedIndexes.forEach(index => {
      newRow[index] = row[index];
    });

    updatedValues.push(rowChanged ? newRow : row);
    backgrounds.push(rowChanged ? newBgRow : new Array(row.length).fill(null));
  });

  if (updatedValues.length > 0) {
    sourceSheet.getRange(2, 1, updatedValues.length, updatedValues[0].length).setValues(updatedValues);
    sourceSheet.getRange(2, 1, backgrounds.length, backgrounds[0].length).setBackgrounds(backgrounds);
    // Apply text formatting for protected fields to keep as plain text
    protectedIndexes.forEach(index => {
      const range = sourceSheet.getRange(2, index + 1, updatedValues.length);
      range.setNumberFormat("@"); // plain text
      range.setHorizontalAlignment("left");
    });
  }

  resultsSheet.clear();
  resultsSheet.getRange('A1').setValue(`Вставлено значень: ${filledCount}`);

  if (missingCategories.size > 0) {
    resultsSheet.getRange('A3').setValue('Категорії без відповідників у Assets:');
    const missingArray = Array.from(missingCategories).sort();
    missingArray.forEach((cat, idx) => {
      resultsSheet.getRange(idx + 4, 1).setValue(cat);
    });
  }

  SpreadsheetApp.getUi().alert(`Операція завершена. Заповнено ${filledCount} значень.`);
}
