<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML Feed Validator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --primary-dark: #4338ca;
            --secondary: #0ea5e9;
            --accent: #f97316;
            --success: #22c55e;
            --warning: #eab308;
            --error: #ef4444;
            --info: #3b82f6;
            --neutral-50: #f9fafb;
            --neutral-100: #f3f4f6;
            --neutral-200: #e5e7eb;
            --neutral-300: #d1d5db;
            --neutral-400: #9ca3af;
            --neutral-500: #6b7280;
            --neutral-600: #4b5563;
            --neutral-700: #374151;
            --neutral-800: #1f2937;
            --neutral-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius-sm: 0.125rem;
            --radius: 0.25rem;
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
            --radius-xl: 0.75rem;
            --font-sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --transition: all 0.2s ease;
        }

        [data-theme="dark"] {
            --neutral-50: #111827;
            --neutral-100: #1f2937;
            --neutral-200: #374151;
            --neutral-300: #4b5563;
            --neutral-400: #6b7280;
            --neutral-500: #9ca3af;
            --neutral-600: #d1d5db;
            --neutral-700: #e5e7eb;
            --neutral-800: #f3f4f6;
            --neutral-900: #f9fafb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--neutral-100);
            color: var(--neutral-800);
            line-height: 1.5;
            min-height: 100vh;
            transition: var(--transition);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--neutral-300);
        }

        .app-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--neutral-600);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.5rem;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            color: var(--primary);
            background-color: var(--neutral-200);
        }

        .auth-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .auth-btn,
        .notifications-btn {
            background: none;
            border: 1px solid var(--neutral-300);
            color: var(--neutral-700);
            padding: 0.35rem 0.75rem;
            border-radius: var(--radius);
            cursor: pointer;
            display: inline-flex;
            gap: 0.35rem;
            align-items: center;
            transition: var(--transition);
            font-size: 0.85rem;
        }

        .auth-btn:hover,
        .notifications-btn:hover:not(:disabled) {
            border-color: var(--primary);
            color: var(--primary);
        }

        .notifications-btn {
            position: relative;
        }

        .notifications-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .notifications-count {
            position: absolute;
            top: -6px;
            right: -6px;
            background-color: var(--error);
            color: white;
            font-size: 0.65rem;
            min-width: 18px;
            height: 18px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-badge {
            display: none;
            flex-direction: column;
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius);
            padding: 0.35rem 0.75rem;
            font-size: 0.75rem;
            background-color: white;
            min-width: 140px;
        }

        .user-role-label {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            text-align: left;
            padding: 0;
            font-size: 0.75rem;
        }

        .notifications-panel {
            position: absolute;
            top: 60px;
            right: 0;
            width: 320px;
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            display: none;
            flex-direction: column;
            z-index: 50;
        }

        .notifications-panel.visible {
            display: flex;
        }

        .notifications-panel header {
            padding: 0.75rem;
            border-bottom: 1px solid var(--neutral-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notifications-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--neutral-100);
        }

        .notification-item.unread {
            background-color: #fff7ed;
        }

        .notification-title {
            font-weight: 600;
            color: var(--neutral-800);
        }

        .notification-meta {
            font-size: 0.75rem;
            color: var(--neutral-500);
            margin-top: 0.25rem;
        }

        .notification-empty {
            padding: 1rem;
            text-align: center;
            color: var(--neutral-500);
        }

        .upload-container {
            background-color: var(--neutral-50);
            padding: 2rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
            text-align: center;
            transition: var(--transition);
        }

        .upload-container h2 {
            margin-bottom: 1rem;
            color: var(--neutral-800);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 1.5rem;
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background-color: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .file-input-button:hover {
            background-color: var(--primary-dark);
        }

        #file-name {
            margin-top: 0.5rem;
            color: var(--neutral-600);
            font-size: 0.875rem;
        }

        .progress-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            display: none;
        }

        .progress-bar {
            height: 0.5rem;
            background-color: var(--neutral-200);
            border-radius: var(--radius-xl);
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--neutral-600);
        }

        .validation-report {
            display: none;
            background-color: var(--neutral-50);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: var(--transition);
        }

        .report-header {
            background-color: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .report-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .report-actions {
            display: flex;
            gap: 1rem;
        }

        .report-action {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .report-action:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .report-action:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .report-summary {
            padding: 1.5rem;
            border-bottom: 1px solid var(--neutral-200);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .summary-card {
            background-color: white;
            padding: 1.25rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
        }

        .summary-card.error {
            border-left: 4px solid var(--error);
        }

        .summary-card.warning {
            border-left: 4px solid var(--warning);
        }

        .summary-card.success {
            border-left: 4px solid var(--success);
        }

        .summary-card.info {
            border-left: 4px solid var(--info);
        }

        .summary-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-600);
            margin-bottom: 0.5rem;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--neutral-800);
        }

        .report-sections {
            padding: 1.5rem;
        }

        .picture-preview {
            display: none;
        }

        .picture-preview .section-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .picture-preview-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        .picture-preview-action {
            background-color: var(--secondary);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            display: inline-flex;
            gap: 0.5rem;
            align-items: center;
            transition: var(--transition);
        }

        .picture-preview-action:disabled {
            background-color: var(--neutral-300);
            cursor: not-allowed;
        }

        .picture-preview-action:not(:disabled):hover {
            background-color: #0284c7;
        }

        .picture-preview-meta {
            font-size: 0.875rem;
            color: var(--neutral-600);
            margin-bottom: 0.75rem;
        }

        .picture-preview-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.75rem;
        }

        .picture-preview-item {
            background-color: white;
            border-radius: var(--radius);
            padding: 0.75rem;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-height: 110px;
        }

        .picture-preview-item a {
            color: var(--primary);
            word-break: break-all;
            font-size: 0.875rem;
        }

        .picture-preview-product {
            font-weight: 600;
            color: var(--neutral-700);
        }

        .picture-preview-dimensions {
            font-size: 0.75rem;
            color: var(--neutral-500);
        }

        .report-section {
            margin-bottom: 1.5rem;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .section-header {
            padding: 1rem 1.5rem;
            background-color: var(--neutral-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .section-download-btn {
            background: var(--primary);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            transition: var(--transition);
            margin-left: 0.5rem;
        }

        .section-download-btn:hover {
            background: var(--primary-dark);
        }

        .section-download-btn.alert {
            background: var(--accent);
        }

        .section-download-btn.alert:hover {
            background: #ea580c;
        }

        .section-header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-header:hover {
            background-color: var(--neutral-200);
        }

        .section-title {
            font-weight: 600;
            color: var(--neutral-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title .icon {
            color: var(--neutral-500);
        }

        .section-title .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--neutral-200);
            color: var(--neutral-700);
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .section-title .badge.error {
            background-color: #fee2e2;
            color: var(--error);
        }

        .section-title .badge.warning {
            background-color: #fef3c7;
            color: var(--warning);
        }

        .section-title .badge.success {
            background-color: #dcfce7;
            color: var(--success);
        }

        .section-title .badge.info {
            background-color: #dbeafe;
            color: var(--info);
        }

        .section-toggle {
            color: var(--neutral-500);
            transition: transform 0.2s ease;
        }

        .section-toggle.expanded {
            transform: rotate(180deg);
        }

        .section-content {
            padding: 1.5rem;
            display: none;
            border-top: 1px solid var(--neutral-200);
        }

        .section-content.expanded {
            display: block;
        }

        .issue-list {
            list-style: none;
        }

        .issue-item {
            padding: 1rem;
            border-bottom: 1px solid var(--neutral-200);
        }

        .issue-item:last-child {
            border-bottom: none;
        }

        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .issue-title {
            font-weight: 500;
            color: var(--neutral-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .issue-icon {
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .issue-icon.error {
            background-color: #fee2e2;
            color: var(--error);
        }

        .issue-icon.warning {
            background-color: #fef3c7;
            color: var(--warning);
        }

        .issue-icon.info {
            background-color: #dbeafe;
            color: var(--info);
        }

        .issue-count {
            font-size: 0.875rem;
            color: var(--neutral-500);
        }

        .issue-details {
            background-color: var(--neutral-50);
            padding: 1rem;
            border-radius: var(--radius);
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .affected-items {
            margin-top: 0.75rem;
        }

        .affected-title {
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--neutral-700);
        }

        .affected-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .affected-item {
            background-color: var(--neutral-100);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius);
            font-size: 0.75rem;
            font-family: var(--font-mono);
        }

        .categories-section {
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .categories-header {
            padding: 1rem 1.5rem;
            background-color: var(--secondary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .categories-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .categories-actions {
            display: flex;
            gap: 0.5rem;
        }

        .categories-action {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .categories-action:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .categories-content {
            padding: 1.5rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .categories-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .categories-table th {
            text-align: left;
            padding: 0.75rem 1rem;
            background-color: var(--neutral-100);
            border-bottom: 2px solid var(--neutral-200);
            color: var(--neutral-700);
            font-weight: 600;
        }

        .categories-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--neutral-200);
            color: var(--neutral-700);
        }

        .categories-table tr:last-child td {
            border-bottom: none;
        }

        .categories-table tr:nth-child(even) {
            background-color: var(--neutral-50);
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .result-table th {
            text-align: left;
            padding: 0.75rem 1rem;
            background-color: var(--neutral-100);
            border-bottom: 2px solid var(--neutral-200);
            color: var(--neutral-700);
            font-weight: 600;
        }

        .result-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--neutral-200);
            color: var(--neutral-700);
        }

        .result-table tr:last-child td {
            border-bottom: none;
        }

        .result-table tr:nth-child(even) {
            background-color: var(--neutral-50);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.error {
            background-color: var(--error);
        }

        .status-dot.warning {
            background-color: var(--warning);
        }

        .status-dot.success {
            background-color: var(--success);
        }

        footer {
            margin-top: 3rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--neutral-300);
            color: var(--neutral-500);
            font-size: 0.875rem;
            text-align: center;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .report-summary {
                grid-template-columns: 1fr;
            }

            .report-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .report-actions {
                width: 100%;
            }

            .section-header {
                padding: 0.75rem 1rem;
            }

            .section-content {
                padding: 1rem;
            }
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }

            100% {
                opacity: 1;
            }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="app-title">
                <i class="fas fa-check-double"></i>
                XML Feed Validator
            </div>
            <div class="auth-controls">
                <button class="notifications-btn" id="notifications-button" disabled title="Нотифікації">
                    <i class="fas fa-bell"></i>
                    <span class="notifications-count" id="notifications-count" style="display:none;">0</span>
                </button>
                <div class="notifications-panel" id="notifications-panel" aria-live="polite">
                    <header>
                        <span>Нотифікації</span>
                        <button class="auth-btn" id="mark-all-read-btn" style="font-size:0.75rem;">Позначити прочитаними</button>
                    </header>
                    <div class="notifications-list" id="notifications-list">
                        <div class="notification-empty">Немає нових повідомлень</div>
                    </div>
                </div>
                <button class="auth-btn" id="login-button">Увійти</button>
                <div class="user-badge" id="user-badge">
                    <span id="user-role-label" class="user-role-label"></span>
                    <span id="user-email-label" class="user-email-label"></span>
                    <button class="logout-btn" id="logout-button">Вийти</button>
                </div>
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
                    <i class="fas fa-sun"></i>
                </button>
            </div>
        </header>

        <div class="upload-container">
            <h2>Завантажте XML файл для валідації</h2>
            <div class="file-input-wrapper">
                <label class="file-input-button">
                    <i class="fas fa-upload"></i>
                    Вибрати файл
                    <input type="file" id="xml-file" class="file-input" accept=".xml">
                </label>
            </div>
            <div id="file-name"></div>
            <div class="progress-container" id="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">Аналіз файлу...</div>
            </div>
        </div>

        <div class="validation-report" id="validation-report">
            <div class="report-header">
                <h2 class="report-title">Звіт валідації</h2>
                <div class="report-actions">
                    <button class="report-action" id="export-report">
                        <i class="fas fa-download"></i>
                        Експорт репорту проблем
                    </button>
                    <button class="report-action" id="export-identifiers" disabled>
                        <i class="fas fa-table"></i>
                        Експорт id-code-title-vendor_code
                    </button>
                    <button class="report-action" id="download-error-log" style="display: none;">
                        <i class="fas fa-bug"></i>
                        Лог помилок
                    </button>
                    <button class="report-action" id="collapse-all">
                        <i class="fas fa-compress-alt"></i>
                        Згорнути все
                    </button>
                    <button class="report-action" id="expand-all">
                        <i class="fas fa-expand-alt"></i>
                        Розгорнути все
                    </button>
                </div>
            </div>

            <div class="report-summary" id="report-summary">
            </div>

            <div class="report-section picture-preview" id="picture-preview">
                <div class="section-header">
                    <div class="section-header-left">
                        <div class="section-title">
                            <i class="fas fa-images icon"></i>
                            Галерея фото з &lt;picture&gt;
                        </div>
                        <div class="picture-preview-actions">
                            <button class="picture-preview-action" id="shuffle-pictures">
                                <i class="fas fa-random"></i>
                                Перемішати
                            </button>
                        </div>
                    </div>
                    <div class="section-toggle" id="picture-preview-toggle">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
                <div class="section-content picture-preview-content" id="picture-preview-content">
                    <div class="picture-preview-meta" id="picture-preview-meta"></div>
                    <div class="picture-preview-list" id="picture-preview-list"></div>
                </div>
            </div>

            <div class="report-sections" id="report-sections">
            </div>
        </div>

        <footer>
            <p>XML Feed Validator &copy; 2025</p>
        </footer>
    </div>

    <div class="modal" id="auth-modal" style="display:none;">
        <div class="modal-content">
            <button class="modal-close" id="close-auth-modal" aria-label="Закрити">
                <i class="fas fa-times"></i>
            </button>
            <h3>Увійти до акаунта</h3>
            <form id="auth-form">
                <label>
                    Email
                    <input type="email" id="auth-email" required placeholder="name@example.com">
                </label>
                <label>
                    Пароль
                    <input type="password" id="auth-password" required placeholder="********">
                </label>
                <button type="submit" class="auth-btn" style="width:100%;justify-content:center;">Увійти</button>
                <div class="form-hint">Акаунти створює адміністратор у Supabase.</div>
                <div class="form-error" id="auth-error" style="display:none;color:var(--error);margin-top:0.5rem;"></div>
            </form>
        </div>
    </div>

    <style>
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 360px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            box-shadow: var(--shadow-lg);
        }

        .modal-content label {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            font-size: 0.9rem;
        }

        .modal-content input {
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius);
            border: 1px solid var(--neutral-300);
        }

        .modal-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
        }

        .form-hint {
            font-size: 0.75rem;
            color: var(--neutral-500);
            text-align: center;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const themeToggle = document.getElementById('theme-toggle');
        const htmlElement = document.documentElement;

        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (savedTheme) {
            htmlElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        } else if (prefersDark) {
            htmlElement.setAttribute('data-theme', 'dark');
            updateThemeIcon('dark');
        }

        themeToggle.addEventListener('click', () => {
            const currentTheme = htmlElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            htmlElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        });

        function updateThemeIcon(theme) {
            themeToggle.innerHTML = theme === 'dark'
                ? '<i class="fas fa-sun"></i>'
                : '<i class="fas fa-moon"></i>';
        }

        const fileInput = document.getElementById('xml-file');
        const fileNameDisplay = document.getElementById('file-name');
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const validationReport = document.getElementById('validation-report');
        const reportSummary = document.getElementById('report-summary');
        const reportSections = document.getElementById('report-sections');
        const picturePreviewContainer = document.getElementById('picture-preview');
        const picturePreviewList = document.getElementById('picture-preview-list');
        const picturePreviewMeta = document.getElementById('picture-preview-meta');
        const shufflePicturesBtn = document.getElementById('shuffle-pictures');
        const picturePreviewContent = document.getElementById('picture-preview-content');
        const picturePreviewToggle = document.getElementById('picture-preview-toggle');
        const exportIdentifiersBtn = document.getElementById('export-identifiers');
        let pictureLinkPool = [];
        let latestResults = null;
        const imageDimensionCache = new Map();
        const imageDimensionPromises = new Map();
        const allowedImageExtensions = ['.jpg', '.jpeg', '.png', '.webp', '.gif', '.bmp', '.tif', '.tiff', '.avif', '.svg', '.heic'];
        const forbiddenIdentifierWords = ['відновлений', 'sale', 'уцінка', 'акція', 'знижка', 'refublished'];

        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const userBadge = document.getElementById('user-badge');
        const userRoleLabel = document.getElementById('user-role-label');
        const userEmailLabel = document.getElementById('user-email-label');
        const authModal = document.getElementById('auth-modal');
        const authForm = document.getElementById('auth-form');
        const authError = document.getElementById('auth-error');
        const closeAuthModalBtn = document.getElementById('close-auth-modal');
        const notificationsButton = document.getElementById('notifications-button');
        const notificationsCountBadge = document.getElementById('notifications-count');
        const notificationsPanel = document.getElementById('notifications-panel');
        const notificationsList = document.getElementById('notifications-list');
        const markAllReadBtn = document.getElementById('mark-all-read-btn');

        const SUPABASE_URL = window.SUPABASE_URL || 'https://mqhjfnrynbhuaboygfxs.supabase.co';
        const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xaGpmbnJ5bmJodWFib3lnZnhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MTQ5ODUsImV4cCI6MjA3OTQ5MDk4NX0.BccW8QZwFzyPiwy93WBVnnqNuJQunrdP6Af3lmtWqTY';
        const supabaseClient = window.supabase?.createClient
            ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
            : null;

        let currentUser = null;
        let currentUserRole = null;
        let notificationsData = [];
        let notificationsChannel = null;

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                fileNameDisplay.textContent = file.name;
                progressContainer.style.display = 'block';
                progressFill.style.width = '0%';
                progressText.textContent = 'Аналіз файлу...';

                validateXMLFile(file);
            }
        });

        document.getElementById('export-report').addEventListener('click', exportReport);
        document.getElementById('download-error-log').addEventListener('click', downloadErrorLog);
        if (exportIdentifiersBtn) {
            exportIdentifiersBtn.addEventListener('click', exportProductIdentifiers);
        }

        document.getElementById('collapse-all').addEventListener('click', () => toggleAllSections(false));
        document.getElementById('expand-all').addEventListener('click', () => toggleAllSections(true));

        if (shufflePicturesBtn) {
            shufflePicturesBtn.addEventListener('click', () => {
                if (pictureLinkPool.length === 0) return;
                renderPicturePreviewSample();
            });
        }

        if (loginButton) {
            loginButton.addEventListener('click', () => {
                if (!supabaseClient) {
                    alert('Supabase не налаштовано. Додайте URL та anon key.');
                    return;
                }
                openAuthModal();
            });
        }

        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                if (!supabaseClient) return;
                await supabaseClient.auth.signOut();
            });
        }

        if (authForm) {
            authForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                await handleAuthSubmit();
            });
        }

        if (closeAuthModalBtn) {
            closeAuthModalBtn.addEventListener('click', closeAuthModal);
        }

        if (notificationsButton) {
            notificationsButton.addEventListener('click', () => {
                if (!currentUser) {
                    alert('Спершу увійдіть до системи.');
                    return;
                }
                notificationsPanel.classList.toggle('visible');
            });
        }

        if (markAllReadBtn) {
            markAllReadBtn.addEventListener('click', markAllNotificationsAsRead);
        }

        document.addEventListener('click', (event) => {
            if (
                notificationsPanel &&
                !notificationsPanel.contains(event.target) &&
                event.target !== notificationsButton
            ) {
                notificationsPanel.classList.remove('visible');
            }
        });

        const picturePreviewHeader = document.querySelector('#picture-preview .section-header');
        if (picturePreviewToggle) {
            picturePreviewToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                togglePicturePreviewContent();
            });
        }
        if (picturePreviewHeader) {
            picturePreviewHeader.addEventListener('click', (e) => {
                if (e.target.closest('#shuffle-pictures')) return;
                if (e.target.closest('#picture-preview-toggle')) return;
                togglePicturePreviewContent();
            });
        }

        if (supabaseClient) {
            initializeAuth();
        } else {
            console.warn('Supabase SDK не ініціалізовано. Укажіть SUPABASE_URL та SUPABASE_ANON_KEY.');
        }

        function toggleAllSections(expand) {
            const sections = document.querySelectorAll('.report-section, .categories-section');
            sections.forEach(section => {
                const toggle = section.querySelector('.section-toggle');
                const content = section.querySelector('.section-content, .categories-content');

                if (expand) {
                    if (toggle) toggle.classList.add('expanded');
                    if (content) content.classList.add('expanded');
                } else {
                    if (toggle) toggle.classList.remove('expanded');
                    if (content) content.classList.remove('expanded');
                }
            });

            if (picturePreviewContainer && picturePreviewContent && picturePreviewContainer.style.display !== 'none') {
                setPicturePreviewExpanded(expand);
            }
        }

        function togglePicturePreviewContent() {
            if (!picturePreviewContent || picturePreviewContainer.style.display === 'none') return;
            const shouldExpand = !picturePreviewContent.classList.contains('expanded');
            setPicturePreviewExpanded(shouldExpand);
        }

        function setPicturePreviewExpanded(expanded) {
            if (!picturePreviewContent) return;
            if (expanded) {
                picturePreviewContent.classList.add('expanded');
                if (picturePreviewToggle) picturePreviewToggle.classList.add('expanded');
            } else {
                picturePreviewContent.classList.remove('expanded');
                if (picturePreviewToggle) picturePreviewToggle.classList.remove('expanded');
            }
        }

        function updateImageDimensions(labelElement, url) {
            if (!labelElement || !url) return;
            if (imageDimensionCache.has(url)) {
                const dims = imageDimensionCache.get(url);
                labelElement.textContent = formatDimensionsText(dims);
                return;
            }

            labelElement.textContent = 'Розміри: завантаження...';
            loadImageDimensions(url)
                .then(dimensions => {
                    if (labelElement.dataset.url !== url) return;
                    labelElement.textContent = formatDimensionsText(dimensions);
                })
                .catch(() => {
                    if (labelElement.dataset.url !== url) return;
                    labelElement.textContent = 'Розміри: недоступні';
                });
        }

        function loadImageDimensions(url) {
            if (imageDimensionCache.has(url)) {
                return Promise.resolve(imageDimensionCache.get(url));
            }
            if (imageDimensionPromises.has(url)) {
                return imageDimensionPromises.get(url);
            }

            const promise = new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function () {
                    const dimensions = {
                        width: img.naturalWidth || img.width,
                        height: img.naturalHeight || img.height
                    };
                    imageDimensionCache.set(url, dimensions);
                    resolve(dimensions);
                };
                img.onerror = reject;
                img.src = url;
            }).finally(() => {
                imageDimensionPromises.delete(url);
            });

            imageDimensionPromises.set(url, promise);
            return promise;
        }

        function formatDimensionsText(dimensions) {
            if (!dimensions || !dimensions.width || !dimensions.height) {
                return 'Розміри: недоступні';
            }
            return `Розміри: ${dimensions.width} × ${dimensions.height}px`;
        }

        async function initializeAuth() {
            try {
                const { data } = await supabaseClient.auth.getSession();
                handleSessionChange(data.session);
                supabaseClient.auth.onAuthStateChange((_event, session) => {
                    handleSessionChange(session);
                });
            } catch (error) {
                console.error('Supabase auth init error:', error);
            }
        }

        async function handleSessionChange(session) {
            currentUser = session?.user || null;
            currentUserRole = null;

            if (currentUser) {
                userEmailLabel.textContent = currentUser.email || '';
                currentUserRole = session?.user?.app_metadata?.role || null;
                if (!currentUserRole) {
                    await fetchUserProfile();
                }
                subscribeToNotifications();
            } else {
                userEmailLabel.textContent = '';
                unsubscribeFromNotifications();
                notificationsData = [];
                renderNotifications();
            }
            updateAuthUI();
        }

        async function fetchUserProfile() {
            if (!currentUser) return;
            try {
                const { data } = await supabaseClient
                    .from('profiles')
                    .select('role, display_name')
                    .eq('id', currentUser.id)
                    .single();
                currentUserRole = data?.role || null;
                if (data?.display_name) {
                    userEmailLabel.textContent = `${data.display_name} (${currentUser.email || ''})`;
                }
            } catch (error) {
                console.error('Не вдалося отримати профіль користувача', error);
            }
        }

        function updateAuthUI() {
            if (!loginButton || !userBadge) return;
            if (currentUser) {
                loginButton.style.display = 'none';
                userBadge.style.display = 'flex';
                userRoleLabel.textContent = currentUserRole
                    ? `Роль: ${currentUserRole}`
                    : 'Роль не визначена';
                notificationsButton.disabled = false;
            } else {
                loginButton.style.display = 'inline-flex';
                userBadge.style.display = 'none';
                notificationsButton.disabled = true;
                notificationsPanel.classList.remove('visible');
                notificationsCountBadge.style.display = 'none';
            }
        }

        function openAuthModal() {
            if (authModal) {
                authModal.style.display = 'flex';
                authError.style.display = 'none';
                authError.textContent = '';
            }
        }

        function closeAuthModal() {
            if (authModal) authModal.style.display = 'none';
            if (authForm) authForm.reset();
            if (authError) {
                authError.style.display = 'none';
                authError.textContent = '';
            }
        }

        async function handleAuthSubmit() {
            if (!supabaseClient) return;
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value;

            authError.style.display = 'none';
            authError.textContent = '';

            try {
                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                closeAuthModal();
            } catch (error) {
                authError.textContent = error.message || 'Помилка авторизації';
                authError.style.display = 'block';
            }
        }

        function unsubscribeFromNotifications() {
            if (notificationsChannel) {
                supabaseClient.removeChannel(notificationsChannel);
                notificationsChannel = null;
            }
        }

        function subscribeToNotifications() {
            if (!currentUser || !currentUserRole) return;
            unsubscribeFromNotifications();
            loadNotifications();
            notificationsChannel = supabaseClient
                .channel('public:notifications')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'notifications' },
                    payload => {
                        handleNotificationChange(payload.new);
                    }
                )
                .subscribe();
        }

        function handleNotificationChange(newNotification) {
            if (!shouldDisplayNotification(newNotification)) return;
            notificationsData = [newNotification, ...notificationsData].slice(0, 25);
            renderNotifications();
        }

        function shouldDisplayNotification(notification) {
            if (!notification) return false;
            if (currentUserRole === 'admin') return true;
            if (notification.target_user && currentUser && notification.target_user === currentUser.id) {
                return true;
            }
            return notification.target_role === currentUserRole;
        }

        async function loadNotifications() {
            if (!currentUserRole) return;
            try {
                let query = supabaseClient
                    .from('notifications')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(25);

                if (currentUserRole !== 'admin') {
                    const filters = [];
                    if (currentUser) filters.push(`target_user.eq.${currentUser.id}`);
                    filters.push(`target_role.eq.${currentUserRole}`);
                    query = query.or(filters.join(','));
                }

                const { data } = await query;
                notificationsData = data || [];
                renderNotifications();
            } catch (error) {
                console.error('Не вдалося отримати нотифікації', error);
            }
        }

        function renderNotifications() {
            if (!notificationsList) return;
            notificationsList.innerHTML = '';
            if (!notificationsData.length) {
                const empty = document.createElement('div');
                empty.className = 'notification-empty';
                empty.textContent = 'Немає повідомлень для відображення';
                notificationsList.appendChild(empty);
                if (notificationsCountBadge) notificationsCountBadge.style.display = 'none';
                return;
            }

            let unread = 0;
            notificationsData.forEach(notification => {
                if (!notification.is_read) unread++;

                const item = document.createElement('div');
                item.className = `notification-item ${notification.is_read ? '' : 'unread'}`;
                const title = document.createElement('div');
                title.className = 'notification-title';
                title.textContent = notification.section || 'Новий запит';

                const meta = document.createElement('div');
                meta.className = 'notification-meta';
                meta.textContent = [
                    notification.partner ? `Партнер: ${notification.partner}` : null,
                    notification.message
                ].filter(Boolean).join(' • ') || 'Без деталей';

                const actionBtn = document.createElement('button');
                actionBtn.className = 'auth-btn';
                actionBtn.style.marginTop = '0.5rem';
                actionBtn.style.fontSize = '0.75rem';
                actionBtn.textContent = notification.is_read ? 'Переглянуто' : 'Позначити прочитаним';
                actionBtn.disabled = notification.is_read;
                actionBtn.addEventListener('click', () => markNotificationAsRead(notification.id));

                item.appendChild(title);
                item.appendChild(meta);
                item.appendChild(actionBtn);
                notificationsList.appendChild(item);
            });

            if (notificationsCountBadge) {
                if (unread > 0) {
                    notificationsCountBadge.style.display = 'flex';
                    notificationsCountBadge.textContent = unread;
                } else {
                    notificationsCountBadge.style.display = 'none';
                }
            }
        }

        async function markNotificationAsRead(notificationId) {
            if (!supabaseClient || !currentUser) return;
            if (!notificationId) return;
            try {
                await supabaseClient
                    .from('notifications')
                    .update({ is_read: true, read_at: new Date().toISOString() })
                    .eq('id', notificationId);
                notificationsData = notificationsData.map(item =>
                    item.id === notificationId ? { ...item, is_read: true } : item
                );
                renderNotifications();
            } catch (error) {
                console.error('Не вдалося оновити нотифікацію', error);
            }
        }

        async function markAllNotificationsAsRead() {
            if (!supabaseClient || !currentUser) return;
            const unreadIds = notificationsData.filter(n => !n.is_read).map(n => n.id);
            if (unreadIds.length === 0) return;
            try {
                await supabaseClient
                    .from('notifications')
                    .update({ is_read: true, read_at: new Date().toISOString() })
                    .in('id', unreadIds);
                notificationsData = notificationsData.map(item => ({ ...item, is_read: true }));
                renderNotifications();
            } catch (error) {
                console.error('Помилка при позначенні нотифікацій як прочитаних', error);
            }
        }

        async function sendNotificationForSection(sectionTitle) {
            if (!supabaseClient || !currentUser) {
                alert('Для цього необхідно увійти.');
                return;
            }
            if (currentUserRole !== 'account_manager' && currentUserRole !== 'admin') {
                alert('Функція доступна лише акаунт-менеджеру.');
                return;
            }
            const partner = prompt('Вкажіть партнера або примітку для аналітика:', '') || 'Невідомо';
            try {
                const { error } = await supabaseClient.rpc('create_notification', {
                    p_partner: partner,
                    p_section: sectionTitle,
                    p_message: `Потрібно перевірити блок "${sectionTitle}"`,
                    p_target_role: 'content_analyst'
                });
                if (error) throw error;
                alert('Нотифікацію надіслано контент-аналітику.');
            } catch (error) {
                console.error('Не вдалося створити нотифікацію', error);
                alert('Сталася помилка при створенні нотифікації.');
            }
        }

        function exportReport() {
            let reportText = "XML Feed Validation Report\n";
            reportText += "=========================\n\n";

            reportText += "Перелік IP-адрес, які потрібно додати у вайтлист на боці партнера, для коректного завантаження фото з фіда:\n";
            reportText += "13.53.52.37\n";
            reportText += "16.16.42.238\n";
            reportText += "13.50.222.109\n";
            reportText += "16.171.78.185\n";
            reportText += "13.48.150.45\n\n";
            reportText += "=========================\n\n";

            const summaryCards = document.querySelectorAll('.summary-card');
            reportText += "Summary:\n";
            summaryCards.forEach(card => {
                const title = card.querySelector('.summary-title').textContent;
                const value = card.querySelector('.summary-value').textContent;
                reportText += `${title}: ${value}\n`;
            });
            reportText += "\n";

            const categoriesTable = document.querySelector('.categories-table');
            if (categoriesTable) {
                reportText += "Categories:\n";
                reportText += "-----------\n";
                const rows = categoriesTable.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 2) {
                        reportText += `${cells[0].textContent.trim()}: ${cells[1].textContent.trim()}\n`;
                    }
                });
                reportText += "\n";
            }

            const sections = document.querySelectorAll('.report-section');
            sections.forEach(section => {
                const title = section.querySelector('.section-title').textContent.trim();
                reportText += `${title}\n${'-'.repeat(title.length)}\n\n`;

                const issueItems = section.querySelectorAll('.issue-item');
                issueItems.forEach(item => {
                    const issueTitle = item.querySelector('.issue-title').textContent.trim();
                    const issueCount = item.querySelector('.issue-count')?.textContent.trim() || '';

                    reportText += `* ${issueTitle} ${issueCount}\n`;

                    const affectedTitle = item.querySelector('.affected-title');
                    if (affectedTitle) {
                        reportText += `  ${affectedTitle.textContent.trim()}\n`;

                        const affectedItems = item.querySelectorAll('.affected-item');
                        affectedItems.forEach(affectedItem => {
                            reportText += `    - ${affectedItem.textContent.trim()}\n`;
                        });
                    }

                    reportText += "\n";
                });
            });

            const blob = new Blob([reportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'validation-report.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportProductIdentifiers() {
            if (!latestResults || !latestResults.productIdentifiers || latestResults.productIdentifiers.length === 0) {
                alert('Немає даних для експорту code/title/vendor_code');
                return;
            }

            let csvContent = 'id,code,title,vendor_code\n';
            latestResults.productIdentifiers.forEach(item => {
                csvContent += [
                    escapeCsvValue(item.productId || ''),
                    escapeCsvValue(item.code || ''),
                    escapeCsvValue(item.title || ''),
                    escapeCsvValue(item.vendorCode || '')
                ].join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'id-code-title-vendor_code.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function escapeCsvValue(value) {
            const stringValue = (value ?? '').toString();
            const escaped = stringValue.replace(/"/g, '""');
            return `"${escaped}"`;
        }

        function exportCategories() {
            const categoriesTable = document.querySelector('.categories-table');
            if (!categoriesTable) return;

            let csvContent = "Category,Product Count\n";
            const rows = categoriesTable.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 2) {
                    csvContent += `"${cells[0].textContent.trim()}","${cells[1].textContent.trim()}"\n`;
                }
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'categories-report.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function copyCategories() {
            const categoriesTable = document.querySelector('.categories-table');
            if (!categoriesTable) return;

            let textContent = "Category\tProduct Count\n";
            const rows = categoriesTable.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 2) {
                    textContent += `${cells[0].textContent.trim()}\t${cells[1].textContent.trim()}\n`;
                }
            });

            navigator.clipboard.writeText(textContent).then(() => {
                const copyBtn = document.querySelector('#copy-categories');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Скопійовано';
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                }, 2000);
            });
        }

        const errorLog = [];

        function logError(type, message, details = {}) {
            errorLog.push({
                type,
                message,
                details,
                timestamp: new Date().toISOString()
            });
            console.error(`[${type}] ${message}`, details);
        }

        function downloadErrorLog() {
            let logText = "Детальний лог помилок валідації\n";
            logText += "================================\n\n";

            errorLog.forEach((entry, index) => {
                logText += `${index + 1}. [${entry.type}] ${entry.message}\n`;
                logText += `   Час: ${entry.timestamp}\n`;
                if (Object.keys(entry.details).length > 0) {
                    logText += `   Деталі: ${JSON.stringify(entry.details, null, 2)}\n`;
                }
                logText += "\n";
            });

            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'validation-error-log.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function validateXMLFile(file) {
            errorLog.length = 0;
            latestResults = null;
            if (exportIdentifiersBtn) {
                exportIdentifiersBtn.disabled = true;
            }

            const fileReader = new FileReader();

            fileReader.onload = async function (event) {
                try {
                    updateProgress(10, 'Розбір XML...');

                    const rawXmlText = event.target.result;

                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(rawXmlText, "text/xml");

                    const parseError = xmlDoc.getElementsByTagName('parsererror');
                    if (parseError.length > 0) {
                        const errorText = parseError[0].textContent;
                        logError('XML_PARSE_ERROR', 'Файл не є валідним XML', { error: errorText });
                        throw new Error(`Помилка парсингу XML: ${errorText}`);
                    }

                    updateProgress(30, 'Аналіз товарів...');

                    const offers = xmlDoc.getElementsByTagName('offer');
                    const totalProducts = offers.length;

                    if (totalProducts === 0) {
                        logError('NO_PRODUCTS', 'У XML файлі не знайдено жодного товару (offer)', {});
                    }

                    const results = {
                        totalProducts,
                        duplicateCodes: [],
                        duplicateIds: [],
                        duplicateVendorCodes: [],
                        duplicateBarcodes: [],
                        missingTitles: [],
                        duplicateTitles: [],
                        missingCategories: [],
                        missingImages: [],
                        invalidBrands: [],
                        emptyParamNames: [],
                        longParamValues: [],
                        missingDimensions: {
                            weight: [],
                            height: [],
                            width: [],
                            length: []
                        },
                        invalidTags: [],
                        poorDescriptions: [],
                        categories: new Map(),
                        rawXmlText: rawXmlText,
                        emptyBrands: [],
                        emptyVendorCodes: [],
                        cyrillicIssues: [],
                        promoInDescriptions: [],
                        vendorCodeMatchesIdOrCode: [],
                        invalidPictureLinks: [],
                        invalidDescriptionImages: [],
                        pictureLinks: [],
                        productIdentifiers: [],
                        invalidCategoryNames: [],
                        forbiddenIdentifierWords: []
                    };

                    const uniqueValues = {
                        codes: new Map(),
                        ids: new Map(),
                        vendorCodes: new Map(),
                        titles: new Map(),
                        barcodes: new Map()
                    };
                    const productsWithValidPicture = new Set();

                    updateProgress(50, 'Валідація товарів...');

                    for (let i = 0; i < offers.length; i++) {
                        const offer = offers[i];

                        const productId = getElementTextContent(offer, 'id') || `Product_${i + 1}`;
                        const cyrillicPattern = /[ыёъЫЁЪ]/;

                        checkUniqueness(offer, 'code', productId, uniqueValues.codes, results.duplicateCodes);

                        checkUniqueness(offer, 'id', productId, uniqueValues.ids, results.duplicateIds);

                        checkUniqueness(offer, 'vendor_code', productId, uniqueValues.vendorCodes, results.duplicateVendorCodes);

                        checkUniqueness(offer, 'barcode', productId, uniqueValues.barcodes, results.duplicateBarcodes);

                        const titleElement = offer.getElementsByTagName('title')[0];
                        const titleValue = titleElement ? titleElement.textContent.trim() : '';
                        if (!titleElement || !titleValue) {
                            results.missingTitles.push(productId);
                        } else {
                            checkUniqueness(offer, 'title', productId, uniqueValues.titles, results.duplicateTitles);
                        }

                        const categoryElement = offer.getElementsByTagName('category')[0];
                        if (!categoryElement || !categoryElement.textContent.trim()) {
                            results.missingCategories.push(productId);
                        } else {
                            const categoryName = categoryElement.textContent.trim();
                            if (results.categories.has(categoryName)) {
                                results.categories.set(categoryName, results.categories.get(categoryName) + 1);
                            } else {
                                results.categories.set(categoryName, 1);
                            }
                            if (cyrillicPattern.test(categoryName)) {
                                results.invalidCategoryNames.push(productId);
                                logError('CATEGORY_INVALID_CHARS', `Товар ${productId} має заборонені символи (ы, ё, ъ) в <category>`, {
                                    productId,
                                    category: categoryName
                                });
                            }
                        }

                        const imageLinkElement = offer.getElementsByTagName('image_link')[0];
                        if (!imageLinkElement || !imageLinkElement.textContent.trim()) {
                            results.missingImages.push(productId);
                        }

                        const pictureElements = offer.getElementsByTagName('picture');
                        let firstValidPicture = null;
                        for (let p = 0; p < pictureElements.length; p++) {
                            const pictureUrl = pictureElements[p].textContent.trim();
                            if (!pictureUrl) continue;

                            if (!isValidImageUrl(pictureUrl)) {
                                results.invalidPictureLinks.push({ productId, url: pictureUrl });
                                logError('INVALID_PICTURE_URL', `Товар ${productId} має некоректне посилання в <picture>`, {
                                    productId,
                                    url: pictureUrl
                                });
                            } else if (!firstValidPicture) {
                                firstValidPicture = pictureUrl;
                            }
                        }

                        if (firstValidPicture && !productsWithValidPicture.has(productId)) {
                            results.pictureLinks.push({ productId, url: firstValidPicture });
                            productsWithValidPicture.add(productId);
                        }

                        const brandElement = offer.getElementsByTagName('brand')[0];
                        if (brandElement) {
                            const serializer = new XMLSerializer();
                            const offerXml = serializer.serializeToString(offer);

                            const brandMatch = offerXml.match(/<brand[^>]*>([^<]*)<\/brand>/);
                            if (brandMatch) {
                                const rawBrandContent = brandMatch[1];
                                const hasPlainAmpersand = /&(?!(amp|quot|lt|gt|apos);)/.test(rawBrandContent);

                                if (hasPlainAmpersand) {
                                    results.invalidBrands.push(productId);
                                    logError('INVALID_BRAND_AMPERSAND', `Товар ${productId} має некодований символ & в бренді`, {
                                        productId,
                                        brandContent: rawBrandContent
                                    });
                                }

                                const trimmedBrand = rawBrandContent.trim();
                                if (trimmedBrand === '' || trimmedBrand === '&nbsp;' || /^\s*$/.test(trimmedBrand)) {
                                    results.emptyBrands.push(productId);
                                    logError('EMPTY_BRAND', `Товар ${productId} має пустий тег <brand>`, {
                                        productId,
                                        brandContent: rawBrandContent
                                    });
                                }
                            }
                        }

                        const vendorCodeElement = offer.getElementsByTagName('vendor_code')[0];
                        const vendorCodeValue = vendorCodeElement ? vendorCodeElement.textContent.trim() : '';
                        if (!vendorCodeValue || vendorCodeValue === '') {
                            results.emptyVendorCodes.push(productId);
                            logError('EMPTY_VENDOR_CODE', `Товар ${productId} має пустий <vendor_code>`, {
                                productId
                            });
                        }

                        const codeElement = offer.getElementsByTagName('code')[0];
                        const codeValue = codeElement ? codeElement.textContent.trim() : '';
                        const barcodeElement = offer.getElementsByTagName('barcode')[0];
                        const barcodeValue = barcodeElement ? barcodeElement.textContent.trim() : '';
                        const idValue = productId.trim();

                        if (vendorCodeValue && (vendorCodeValue === idValue || vendorCodeValue === codeValue)) {
                            results.vendorCodeMatchesIdOrCode.push({
                                productId,
                                vendorCode: vendorCodeValue,
                                matchesId: vendorCodeValue === idValue,
                                matchesCode: vendorCodeValue === codeValue
                            });
                            logError('VENDOR_CODE_MATCH', `Товар ${productId} має vendor_code, який співпадає з id або code`, {
                                productId,
                                vendorCode: vendorCodeValue,
                                id: idValue,
                                code: codeValue
                            });
                        }

                        checkForbiddenWordsInField(productId, 'code', codeValue, results);
                        checkForbiddenWordsInField(productId, 'vendor_code', vendorCodeValue, results);
                        checkForbiddenWordsInField(productId, 'barcode', barcodeValue, results);
                        checkForbiddenWordsInField(productId, 'title', titleValue, results);

                        results.productIdentifiers.push({
                            productId,
                            code: codeValue,
                            title: titleValue,
                            vendorCode: vendorCodeValue
                        });

                        if (titleElement) {
                            const titleText = titleElement.textContent;
                            if (cyrillicPattern.test(titleText)) {
                                results.cyrillicIssues.push({
                                    productId,
                                    field: 'title',
                                    content: titleText.substring(0, 100)
                                });
                                logError('CYRILLIC_ISSUE', `Товар ${productId} має заборонені символи (ы, ё, ъ) в <title>`, {
                                    productId,
                                    field: 'title'
                                });
                            }
                        }

                        const descriptionElement = offer.getElementsByTagName('description')[0];
                        if (descriptionElement) {
                            const descText = descriptionElement.textContent;
                            if (cyrillicPattern.test(descText)) {
                                results.cyrillicIssues.push({
                                    productId,
                                    field: 'description',
                                    content: descText.substring(0, 100)
                                });
                                logError('CYRILLIC_ISSUE', `Товар ${productId} має заборонені символи (ы, ё, ъ) в <description>`, {
                                    productId,
                                    field: 'description'
                                });
                            }

                            const promoWords = ['акція', 'акция', 'гарантія', 'гарантия', 'купити', 'купить', 'придбати', 'приобрести', 'на сайті', 'на сайте'];

                            const descLower = descText.toLowerCase();
                            const foundPromoWords = promoWords.filter(word => descLower.includes(word));
                            const uniquePromoWords = Array.from(new Set(foundPromoWords.map(word => word.toLowerCase())));
                            const uniquePhones = findUkrainianPhoneNumbers(descText);

                            if (uniquePromoWords.length > 0 || uniquePhones.length > 0) {
                                results.promoInDescriptions.push({
                                    productId,
                                    promoWords: uniquePromoWords,
                                    phones: uniquePhones
                                });
                                logError('PROMO_IN_DESCRIPTION', `Товар ${productId} має промо-фрази або телефони в <description>`, {
                                    productId,
                                    promoWords: uniquePromoWords,
                                    phones: uniquePhones
                                });
                            }

                            const descContent = descText.trim();
                            if (!descContent || descContent.length <= 20) {
                                results.poorDescriptions.push(productId);
                            }

                            const descriptionImages = extractDescriptionImageUrls(descText);
                            descriptionImages.forEach(imageUrl => {
                                if (!isValidImageUrl(imageUrl)) {
                                    results.invalidDescriptionImages.push({ productId, url: imageUrl });
                                    logError('INVALID_DESCRIPTION_IMAGE', `Товар ${productId} має некоректне посилання на фото в <description>`, {
                                        productId,
                                        url: imageUrl
                                    });
                                }
                            });
                        }

                        const paramElements = offer.getElementsByTagName('param');
                        for (let j = 0; j < paramElements.length; j++) {
                            const param = paramElements[j];
                            const paramName = param.getAttribute('name');
                            const paramValue = param.textContent.trim();

                            if (!paramName || paramName.trim() === '') {
                                results.emptyParamNames.push({
                                    productId,
                                    paramValue: paramValue || '(порожнє значення)'
                                });
                                logError('EMPTY_PARAM_NAME', `Товар ${productId} має параметр без назви`, {
                                    productId,
                                    paramValue
                                });
                            } else {
                                if (cyrillicPattern.test(paramName)) {
                                    results.cyrillicIssues.push({
                                        productId,
                                        field: 'param name',
                                        content: paramName
                                    });
                                    logError('CYRILLIC_ISSUE', `Товар ${productId} має заборонені символи (ы, ё, ъ) в <param name>`, {
                                        productId,
                                        paramName
                                    });
                                }
                            }

                            if (paramValue && paramValue.length > 2000) {
                                results.longParamValues.push({
                                    productId,
                                    paramName: paramName || '(без назви)',
                                    valueLength: paramValue.length
                                });
                                logError('LONG_PARAM_VALUE', `Товар ${productId} має параметр "${paramName}" зі значенням довше 2000 символів`, {
                                    productId,
                                    paramName,
                                    valueLength: paramValue.length
                                });
                            }
                        }

                        checkDimensionPresence(offer, 'weight', productId, results.missingDimensions.weight);
                        checkDimensionPresence(offer, 'height', productId, results.missingDimensions.height);
                        checkDimensionPresence(offer, 'width', productId, results.missingDimensions.width);
                        checkDimensionPresence(offer, 'length', productId, results.missingDimensions.length);

                        const tagsElement = offer.getElementsByTagName('tags')[0];
                        if (tagsElement) {
                            const tagsHtml = new XMLSerializer().serializeToString(tagsElement);
                            if (!tagsHtml.includes('</tags>')) {
                                results.invalidTags.push(productId);
                            }
                        }

                        if (i % Math.ceil(offers.length / 10) === 0) {
                            const progress = 50 + Math.floor((i / offers.length) * 40);
                            updateProgress(progress, `Проаналізовано ${i}/${offers.length} товарів...`);
                        }
                    }

                    results.categories = Array.from(results.categories.entries())
                        .map(([name, count]) => ({ name, count }))
                        .sort((a, b) => b.count - a.count);

                    updateProgress(90, 'Генерація звіту...');

                    latestResults = results;
                    if (exportIdentifiersBtn) {
                        exportIdentifiersBtn.disabled = results.productIdentifiers.length === 0;
                    }

                    generateValidationReport(results);

                    updateProgress(100, 'Аналіз завершено');
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 1000);

                } catch (error) {
                    console.error('Validation error:', error);
                    logError('CRITICAL_ERROR', error.message, { stack: error.stack });
                    progressText.textContent = `Помилка: ${error.message}`;
                    progressFill.style.width = '100%';
                    progressFill.style.backgroundColor = 'var(--error)';

                    if (errorLog.length > 0) {
                        setTimeout(() => {
                            if (confirm('Виникла помилка. Бажаєте завантажити детальний лог помилок?')) {
                                downloadErrorLog();
                            }
                        }, 500);
                    }
                }
            };

            fileReader.readAsText(file);
        }

        function getElementTextContent(parentElement, tagName) {
            const element = parentElement.getElementsByTagName(tagName)[0];
            return element ? element.textContent.trim() : '';
        }

        function isValidImageUrl(url) {
            if (!url) return false;
            try {
                const parsed = new URL(url.trim());
                if (!['http:', 'https:'].includes(parsed.protocol)) {
                    return false;
                }
                const pathname = parsed.pathname.toLowerCase();
                return allowedImageExtensions.some(ext => pathname.endsWith(ext));
            } catch (error) {
                return false;
            }
        }

        function extractDescriptionImageUrls(descriptionHtml) {
            if (!descriptionHtml) return [];
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = descriptionHtml;
            const imgElements = tempDiv.querySelectorAll('img');
            return Array.from(imgElements)
                .map(img => img.getAttribute('src'))
                .filter(src => !!src && src.trim().length > 0)
                .map(src => src.trim());
        }

        function findUkrainianPhoneNumbers(text) {
            if (!text) return [];
            const candidatePattern = /(\+?\d[\d\s\-()]{5,}\d)/g;
            const uniquePhones = new Set();
            const matches = [];
            let match;

            while ((match = candidatePattern.exec(text)) !== null) {
                const rawPhone = match[0].trim();
                const cleaned = rawPhone.replace(/[\s\-()]/g, '');
                const hasPlus = cleaned.startsWith('+');
                const digitsOnly = cleaned.replace(/\D/g, '');

                if (!isUkrainianPhoneNumber(digitsOnly)) continue;

                const key = (hasPlus ? '+' : '') + digitsOnly;
                if (uniquePhones.has(key)) continue;

                uniquePhones.add(key);
                matches.push(rawPhone);
            }

            return matches;
        }

        function isUkrainianPhoneNumber(digitsOnly) {
            if (!digitsOnly || digitsOnly.length < 7) return false;

            if (digitsOnly.startsWith('380')) {
                return digitsOnly.length >= 10 && digitsOnly.length <= 12;
            }

            if (digitsOnly.length >= 7 && digitsOnly.length <= 9) {
                return digitsOnly.startsWith('0');
            }

            return false;
        }

        function findForbiddenIdentifierWord(value) {
            if (!value) return null;
            const lowerValue = value.toLowerCase();
            for (const word of forbiddenIdentifierWords) {
                if (lowerValue.includes(word.toLowerCase())) {
                    return word;
                }
            }
            return null;
        }

        function checkForbiddenWordsInField(productId, fieldName, fieldValue, results) {
            const matchedWord = findForbiddenIdentifierWord(fieldValue);
            if (!matchedWord) return;

            results.forbiddenIdentifierWords.push({
                productId,
                field: fieldName,
                word: matchedWord,
                value: fieldValue
            });

            logError('FORBIDDEN_IDENTIFIER_WORD', `Товар ${productId} містить заборонене слово "${matchedWord}" у полі <${fieldName}>`, {
                productId,
                field: fieldName,
                value: fieldValue,
                word: matchedWord
            });
        }

        function checkUniqueness(offer, tagName, productId, uniqueMap, resultArray) {
            const element = offer.getElementsByTagName(tagName)[0];
            if (element && element.textContent.trim()) {
                const value = element.textContent.trim();

                if (uniqueMap.has(value)) {
                    const duplicateInfo = uniqueMap.get(value);
                    duplicateInfo.count++;
                    duplicateInfo.products.push(productId);

                    const existingDuplicate = resultArray.find(d => d.value === value);
                    if (existingDuplicate) {
                        existingDuplicate.products.push(productId);
                    } else {
                        resultArray.push({
                            value,
                            products: [duplicateInfo.firstProduct, productId],
                            count: duplicateInfo.count
                        });
                    }
                } else {
                    uniqueMap.set(value, {
                        firstProduct: productId,
                        count: 1,
                        products: [productId]
                    });
                }
            }
        }

        function checkDimensionPresence(offer, dimensionName, productId, resultArray) {
            const element = offer.getElementsByTagName(dimensionName)[0];
            if (!element || !element.textContent.trim()) {
                resultArray.push(productId);
            }
        }

        function updateProgress(percentage, text) {
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = text;
        }

        function setupPicturePreview(pictureLinks) {
            if (!picturePreviewContainer || !picturePreviewList) return;

            pictureLinkPool = pictureLinks ? [...pictureLinks] : [];

            if (pictureLinkPool.length === 0) {
                picturePreviewContainer.style.display = 'none';
                picturePreviewList.innerHTML = '';
                if (picturePreviewMeta) {
                    picturePreviewMeta.textContent = '';
                }
                setPicturePreviewExpanded(false);
                return;
            }

            picturePreviewContainer.style.display = 'block';
            setPicturePreviewExpanded(true);

            if (shufflePicturesBtn) {
                shufflePicturesBtn.disabled = pictureLinkPool.length <= 1;
            }

            renderPicturePreviewSample();
        }

        function renderPicturePreviewSample() {
            if (!picturePreviewContainer || pictureLinkPool.length === 0) return;
            const sample = getRandomPictureSample(10);
            renderPicturePreview(sample);
        }

        function getRandomPictureSample(count = 10) {
            if (pictureLinkPool.length <= count) {
                return [...pictureLinkPool];
            }
            const shuffled = [...pictureLinkPool];
            shuffleArray(shuffled);
            return shuffled.slice(0, count);
        }

        function renderPicturePreview(sample) {
            if (!picturePreviewList) return;

            picturePreviewList.innerHTML = '';

            sample.forEach(item => {
                const previewItem = document.createElement('div');
                previewItem.className = 'picture-preview-item';

                const productLabel = document.createElement('div');
                productLabel.className = 'picture-preview-product';
                productLabel.textContent = `Товар: ${item.productId}`;

                const link = document.createElement('a');
                link.href = item.url;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.textContent = item.url;

                const dimensionsLabel = document.createElement('div');
                dimensionsLabel.className = 'picture-preview-dimensions';
                dimensionsLabel.textContent = 'Розміри: завантаження...';
                dimensionsLabel.dataset.url = item.url;
                updateImageDimensions(dimensionsLabel, item.url);

                previewItem.appendChild(productLabel);
                previewItem.appendChild(link);
                previewItem.appendChild(dimensionsLabel);
                picturePreviewList.appendChild(previewItem);
            });

            if (picturePreviewMeta) {
                picturePreviewMeta.textContent = `Показано ${sample.length} з ${pictureLinkPool.length} фото`;
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function generateValidationReport(results) {
            validationReport.style.display = 'block';

            const errorLogBtn = document.getElementById('download-error-log');
            if (errorLog.length > 0) {
                errorLogBtn.style.display = 'flex';
            } else {
                errorLogBtn.style.display = 'none';
            }

            reportSummary.innerHTML = '';
            reportSections.innerHTML = '';

            generateSummaryCards(results);

            setupPicturePreview(results.pictureLinks);

            generateCategoriesSection(results.categories);

            const criticalIssues = [
                { name: 'Дублікати кодів', items: results.duplicateCodes.flatMap(d => d.products) },
                { name: 'Відсутні назви товарів', items: results.missingTitles },
                { name: 'Відсутні категорії', items: results.missingCategories },
                { name: 'Відсутні фото (image_link)', items: results.missingImages },
                { name: 'Параметри без назви (name="")', items: results.emptyParamNames.map(p => p.productId) },
                { name: 'Параметри з довгими значеннями (>2000 символів)', items: results.longParamValues.map(p => p.productId) },
                { name: 'Пустий тег <brand>', items: results.emptyBrands },
                { name: 'Пустий тег <vendor_code>', items: results.emptyVendorCodes },
                { name: 'Категорії ру мовою', items: results.invalidCategoryNames },
                { name: 'Уцінка, акція, рефаблішд товар', items: results.forbiddenIdentifierWords.map(item => `${item.productId} (${item.field})`) },
                { name: 'Некоректні посилання в <picture>', items: results.invalidPictureLinks.map(item => `${item.productId}: ${item.url || '(порожній URL)'}`) },
                { name: 'Некоректні посилання в описі (img src)', items: results.invalidDescriptionImages.map(item => `${item.productId}: ${item.url || '(порожній URL)'}`) }
            ];

            generateMissingFieldsSection('Критичні проблеми', criticalIssues, 'error');

            generateDuplicateSection('code', 'Дублікати кодів', results.duplicateCodes);
            generateDuplicateSection('id', 'Дублікати ID', results.duplicateIds);
            generateDuplicateSection('vendor_code', 'Дублікати вендор-кодів', results.duplicateVendorCodes);
            generateDuplicateSection('barcode', 'Дублікати штрих-кодів', results.duplicateBarcodes);
            generateDuplicateSection('title', 'Дублікати назв', results.duplicateTitles);

            if (results.vendorCodeMatchesIdOrCode.length > 0) {
                generateWarningsSection('Попередження', results.vendorCodeMatchesIdOrCode);
            }

            const missingFields = [
                { name: 'Відсутня вага', items: results.missingDimensions.weight },
                { name: 'Відсутня висота', items: results.missingDimensions.height },
                { name: 'Відсутня ширина', items: results.missingDimensions.width },
                { name: 'Відсутня довжина', items: results.missingDimensions.length }
            ];

            generateMissingFieldsSection('Відсутні додаткові поля', missingFields, 'warning');

            const formattingIssues = [
                { name: 'Некоректний символ & в бренді (потрібно &amp;)', items: results.invalidBrands },
                { name: 'Некоректні або пусті теги <tags> (атрибути та значення товару)', items: results.invalidTags },
                { name: 'Пусті описи (≤20 символів)', items: results.poorDescriptions },
                { name: 'Ру мова в <title>, <description>, <param name>', items: results.cyrillicIssues.map(c => c.productId) },
                {
                    name: 'Промо-фрази або телефони в <description>',
                    items: results.promoInDescriptions.map(p => ({
                        productId: p.productId,
                        promoWords: p.promoWords || [],
                        phones: p.phones || []
                    }))
                }
            ];

            generateMissingFieldsSection('Проблеми форматування', formattingIssues, 'warning');

            addSectionToggleListeners();

            const firstSection = document.querySelector('.report-section, .categories-section');
            if (firstSection) {
                const toggle = firstSection.querySelector('.section-toggle');
                const content = firstSection.querySelector('.section-content, .categories-content');
                if (toggle) toggle.classList.add('expanded');
                if (content) content.classList.add('expanded');
            }
        }

        function generateCategoriesSection(categories) {
            if (categories.length === 0) return;

            const section = document.createElement('div');
            section.className = 'categories-section';

            const header = document.createElement('div');
            header.className = 'categories-header';

            const title = document.createElement('div');
            title.className = 'categories-title';
            title.innerHTML = '<i class="fas fa-tags"></i> Категорії товарів';

            const actions = document.createElement('div');
            actions.className = 'categories-actions';

            const copyBtn = document.createElement('button');
            copyBtn.className = 'categories-action';
            copyBtn.id = 'copy-categories';
            copyBtn.innerHTML = '<i class="fas fa-copy"></i> Копіювати';
            copyBtn.onclick = copyCategories;

            const exportBtn = document.createElement('button');
            exportBtn.className = 'categories-action';
            exportBtn.innerHTML = '<i class="fas fa-download"></i> Експорт CSV';
            exportBtn.onclick = exportCategories;

            actions.appendChild(copyBtn);
            actions.appendChild(exportBtn);

            header.appendChild(title);
            header.appendChild(actions);

            const content = document.createElement('div');
            content.className = 'categories-content expanded';

            const table = document.createElement('table');
            table.className = 'categories-table';

            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Категорія</th>
                    <th>Кількість товарів</th>
                </tr>
            `;

            const tbody = document.createElement('tbody');
            categories.forEach(category => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${category.name}</td>
                    <td>${category.count}</td>
                `;
                tbody.appendChild(row);
            });

            table.appendChild(thead);
            table.appendChild(tbody);
            content.appendChild(table);

            section.appendChild(header);
            section.appendChild(content);

            reportSections.appendChild(section);
        }

        function generateSummaryCards(results) {
            addSummaryCard('Усього товарів', results.totalProducts, 'success');

            addSummaryCard('Категорій', results.categories.length, 'success');

            const criticalIssues = results.missingTitles.length +
                results.missingCategories.length +
                results.missingImages.length +
                results.duplicateCodes.length +
                results.emptyParamNames.length +
                results.longParamValues.length +
                results.emptyBrands.length +
                results.emptyVendorCodes.length;
            const criticalSeverity = criticalIssues > 0 ? 'error' : 'success';
            addSummaryCard('Критичні проблеми', criticalIssues, criticalSeverity);

            const totalDuplicates = results.duplicateCodes.length +
                results.duplicateIds.length +
                results.duplicateVendorCodes.length +
                results.duplicateBarcodes.length +
                results.duplicateTitles.length;

            const duplicateSeverity = totalDuplicates > 0 ? 'error' : 'success';
            addSummaryCard('Дублікати', totalDuplicates, duplicateSeverity);

            const warnings = results.vendorCodeMatchesIdOrCode.length;
            const warningSeverity = warnings > 0 ? 'info' : 'success';
            addSummaryCard('Попередження', warnings, warningSeverity);

            const totalMissing = results.missingDimensions.weight.length +
                results.missingDimensions.height.length +
                results.missingDimensions.width.length +
                results.missingDimensions.length.length;

            const missingSeverity = totalMissing > 0 ? 'warning' : 'success';
            addSummaryCard('Відсутні поля', totalMissing, missingSeverity);
        }

        function countTotalIssues(results) {
            return results.duplicateCodes.length +
                results.duplicateIds.length +
                results.duplicateVendorCodes.length +
                results.duplicateBarcodes.length +
                results.duplicateTitles.length +
                results.missingTitles.length +
                results.missingCategories.length +
                results.missingImages.length +
                results.invalidBrands.length +
                results.invalidTags.length +
                results.poorDescriptions.length +
                results.missingDimensions.weight.length +
                results.missingDimensions.height.length +
                results.missingDimensions.width.length +
                results.missingDimensions.length.length;
        }

        function addSummaryCard(title, value, type) {
            const card = document.createElement('div');
            card.className = `summary-card ${type}`;

            const titleElement = document.createElement('div');
            titleElement.className = 'summary-title';
            titleElement.textContent = title;

            const valueElement = document.createElement('div');
            valueElement.className = 'summary-value';
            valueElement.textContent = value;

            card.appendChild(titleElement);
            card.appendChild(valueElement);

            reportSummary.appendChild(card);
        }

        function generateWarningsSection(sectionTitle, warnings) {
            const section = createSection(sectionTitle, 'fa-info-circle', warnings.length, 'info');
            const content = section.querySelector('.section-content');

            const header = section.querySelector('.section-header');
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'section-download-btn';
            downloadBtn.innerHTML = '<i class="fas fa-download"></i>';
            downloadBtn.title = 'Завантажити звіт';
            downloadBtn.onclick = (e) => {
                e.stopPropagation();
                exportWarningsReport(warnings);
            };

            const leftContainer = document.createElement('div');
            leftContainer.className = 'section-header-left';
            const titleElement = header.querySelector('.section-title');
            const toggleElement = header.querySelector('.section-toggle');

            header.innerHTML = '';
            leftContainer.appendChild(titleElement);
            leftContainer.appendChild(downloadBtn);
            appendEscalateButton(leftContainer, sectionTitle, 'info', warnings.length);
            header.appendChild(leftContainer);
            header.appendChild(toggleElement);

            const issueList = document.createElement('ul');
            issueList.className = 'issue-list';

            const issueItem = document.createElement('li');
            issueItem.className = 'issue-item';

            const issueHeader = document.createElement('div');
            issueHeader.className = 'issue-header';

            const issueTitle = document.createElement('div');
            issueTitle.className = 'issue-title';

            const issueIcon = document.createElement('span');
            issueIcon.className = 'issue-icon info';
            issueIcon.innerHTML = '<i class="fas fa-info-circle"></i>';

            issueTitle.appendChild(issueIcon);
            issueTitle.appendChild(document.createTextNode('Потребується перевірка вендор-кодів'));

            const issueCount = document.createElement('div');
            issueCount.className = 'issue-count';
            issueCount.textContent = `${warnings.length} товарів`;

            issueHeader.appendChild(issueTitle);
            issueHeader.appendChild(issueCount);

            const issueDetails = document.createElement('div');
            issueDetails.className = 'issue-details';

            const affectedItems = document.createElement('div');
            affectedItems.className = 'affected-items';

            const affectedTitle = document.createElement('div');
            affectedTitle.className = 'affected-title';
            affectedTitle.textContent = 'Товари з vendor_code, що співпадає з id або code:';

            const affectedList = document.createElement('div');
            affectedList.className = 'affected-list';

            warnings.forEach(warning => {
                const affectedItem = document.createElement('span');
                affectedItem.className = 'affected-item';
                affectedItem.textContent = warning.productId;
                affectedItem.title = `vendor_code: ${warning.vendorCode}`;
                affectedList.appendChild(affectedItem);
            });

            affectedItems.appendChild(affectedTitle);
            affectedItems.appendChild(affectedList);

            issueDetails.appendChild(affectedItems);

            issueItem.appendChild(issueHeader);
            issueItem.appendChild(issueDetails);

            issueList.appendChild(issueItem);

            content.appendChild(issueList);
            reportSections.appendChild(section);
        }

        function exportWarningsReport(warnings) {
            let reportText = "Попередження: Потребується перевірка вендор-кодів\n";
            reportText += "=".repeat(50) + "\n\n";

            warnings.forEach(warning => {
                reportText += `Товар: ${warning.productId}\n`;
                reportText += `  vendor_code: ${warning.vendorCode}\n`;
                if (warning.matchesId) reportText += `  ⚠️ Співпадає з ID\n`;
                if (warning.matchesCode) reportText += `  ⚠️ Співпадає з CODE\n`;
                reportText += "\n";
            });

            const blob = new Blob([reportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'vendor_code_warnings.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function generateDuplicateSection(fieldName, sectionTitle, duplicates) {
            if (duplicates.length === 0) return;

            const section = createSection(sectionTitle, 'fa-clone', duplicates.length, 'error');
            const content = section.querySelector('.section-content');

            const header = section.querySelector('.section-header');
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'section-download-btn';
            downloadBtn.innerHTML = '<i class="fas fa-download"></i>';
            downloadBtn.title = 'Завантажити звіт';
            downloadBtn.onclick = (e) => {
                e.stopPropagation();
                exportSectionReport(sectionTitle, duplicates, 'duplicate');
            };

            const leftContainer = document.createElement('div');
            leftContainer.className = 'section-header-left';
            const titleElement = header.querySelector('.section-title');
            const toggleElement = header.querySelector('.section-toggle');

            header.innerHTML = '';
            leftContainer.appendChild(titleElement);
            leftContainer.appendChild(downloadBtn);
            header.appendChild(leftContainer);
            header.appendChild(toggleElement);

            appendEscalateButton(leftContainer, sectionTitle, 'error', duplicates.length);

            const issueList = document.createElement('ul');
            issueList.className = 'issue-list';

            duplicates.forEach(duplicate => {
                const issueItem = document.createElement('li');
                issueItem.className = 'issue-item';

                const issueHeader = document.createElement('div');
                issueHeader.className = 'issue-header';

                const issueTitle = document.createElement('div');
                issueTitle.className = 'issue-title';

                const issueIcon = document.createElement('span');
                issueIcon.className = 'issue-icon error';
                issueIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';

                issueTitle.appendChild(issueIcon);
                issueTitle.appendChild(document.createTextNode(`Дублікат значення: ${duplicate.value}`));

                const issueCount = document.createElement('div');
                issueCount.className = 'issue-count';
                issueCount.textContent = `${duplicate.products.length} товарів`;

                issueHeader.appendChild(issueTitle);
                issueHeader.appendChild(issueCount);

                const issueDetails = document.createElement('div');
                issueDetails.className = 'issue-details';

                const affectedItems = document.createElement('div');
                affectedItems.className = 'affected-items';

                const affectedTitle = document.createElement('div');
                affectedTitle.className = 'affected-title';
                affectedTitle.textContent = 'Товари з цим значенням:';

                const affectedList = document.createElement('div');
                affectedList.className = 'affected-list';

                duplicate.products.forEach(productId => {
                    const affectedItem = document.createElement('span');
                    affectedItem.className = 'affected-item';
                    affectedItem.textContent = productId;
                    affectedList.appendChild(affectedItem);
                });

                affectedItems.appendChild(affectedTitle);
                affectedItems.appendChild(affectedList);

                issueDetails.appendChild(affectedItems);

                issueItem.appendChild(issueHeader);
                issueItem.appendChild(issueDetails);

                issueList.appendChild(issueItem);
            });

            content.appendChild(issueList);
            reportSections.appendChild(section);
        }

        function generateMissingFieldsSection(sectionTitle, fields, severity = 'warning') {
            let totalItems = 0;
            fields.forEach(field => {
                totalItems += field.items.length;
            });

            if (totalItems === 0) return;

            const iconClass = severity === 'error' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle';
            const section = createSection(sectionTitle, iconClass, totalItems, severity);
            const content = section.querySelector('.section-content');

            const header = section.querySelector('.section-header');
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'section-download-btn';
            downloadBtn.innerHTML = '<i class="fas fa-download"></i>';
            downloadBtn.title = 'Завантажити звіт';
            downloadBtn.onclick = (e) => {
                e.stopPropagation();
                exportSectionReport(sectionTitle, fields, 'missing');
            };

            const leftContainer = document.createElement('div');
            leftContainer.className = 'section-header-left';
            const titleElement = header.querySelector('.section-title');
            const toggleElement = header.querySelector('.section-toggle');

            header.innerHTML = '';
            leftContainer.appendChild(titleElement);
            leftContainer.appendChild(downloadBtn);
            header.appendChild(leftContainer);
            header.appendChild(toggleElement);

            appendEscalateButton(leftContainer, sectionTitle, severity, totalItems);

            const issueList = document.createElement('ul');
            issueList.className = 'issue-list';

            fields.forEach(field => {
                if (field.items.length === 0) return;

                const issueItem = document.createElement('li');
                issueItem.className = 'issue-item';

                const issueHeader = document.createElement('div');
                issueHeader.className = 'issue-header';

                const issueTitle = document.createElement('div');
                issueTitle.className = 'issue-title';

                const issueIcon = document.createElement('span');
                issueIcon.className = `issue-icon ${severity}`;
                const iconName = severity === 'error' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle';
                issueIcon.innerHTML = `<i class="fas ${iconName}"></i>`;

                issueTitle.appendChild(issueIcon);
                issueTitle.appendChild(document.createTextNode(field.name));

                const issueCount = document.createElement('div');
                issueCount.className = 'issue-count';
                issueCount.textContent = `${field.items.length} товарів`;

                issueHeader.appendChild(issueTitle);
                issueHeader.appendChild(issueCount);

                const issueDetails = document.createElement('div');
                issueDetails.className = 'issue-details';

                const affectedItems = document.createElement('div');
                affectedItems.className = 'affected-items';

                const affectedTitle = document.createElement('div');
                affectedTitle.className = 'affected-title';
                affectedTitle.textContent = 'Проблемні товари:';

                const affectedList = document.createElement('div');
                affectedList.className = 'affected-list';

                field.items.forEach(item => {
                    const affectedItem = document.createElement('span');
                    affectedItem.className = 'affected-item';
                    let labelParts = [];
                    if (typeof item === 'string' || typeof item === 'number') {
                        labelParts.push(String(item));
                    } else if (item && typeof item === 'object') {
                        if (item.productId) {
                            labelParts.push(item.productId);
                        }
                        if (Array.isArray(item.promoWords) && item.promoWords.length > 0) {
                            labelParts.push(`слова: ${Array.from(new Set(item.promoWords)).join(', ')}`);
                        }
                        if (Array.isArray(item.phones) && item.phones.length > 0) {
                            labelParts.push(`телефони: ${Array.from(new Set(item.phones)).join(', ')}`);
                        }
                    }
                    affectedItem.textContent = labelParts.length > 0 ? labelParts.join(' | ') : '(немає даних)';
                    affectedList.appendChild(affectedItem);
                });

                affectedItems.appendChild(affectedTitle);
                affectedItems.appendChild(affectedList);

                issueDetails.appendChild(affectedItems);

                issueItem.appendChild(issueHeader);
                issueItem.appendChild(issueDetails);

                issueList.appendChild(issueItem);
            });

            content.appendChild(issueList);
            reportSections.appendChild(section);
        }

        function createSection(title, iconClass, count, type) {
            const section = document.createElement('div');
            section.className = 'report-section';

            const header = document.createElement('div');
            header.className = 'section-header';

            const sectionTitle = document.createElement('div');
            sectionTitle.className = 'section-title';

            const icon = document.createElement('i');
            icon.className = `fas ${iconClass} icon`;

            sectionTitle.appendChild(icon);
            sectionTitle.appendChild(document.createTextNode(title));

            if (count > 0) {
                const badge = document.createElement('span');
                badge.className = `badge ${type}`;
                badge.textContent = count;
                sectionTitle.appendChild(badge);
            }

            const toggle = document.createElement('div');
            toggle.className = 'section-toggle';
            toggle.innerHTML = '<i class="fas fa-chevron-down"></i>';

            header.appendChild(sectionTitle);
            header.appendChild(toggle);

            const content = document.createElement('div');
            content.className = 'section-content';

            section.appendChild(header);
            section.appendChild(content);

            return section;
        }

        function canEscalateSection(issueCount, severity) {
            if (!currentUserRole) return false;
            if (!['account_manager', 'admin'].includes(currentUserRole)) return false;
            if (!issueCount || issueCount <= 0) return false;
            return severity === 'error' || severity === 'warning';
        }

        function appendEscalateButton(container, sectionTitle, severity, issueCount) {
            if (!container) return;
            if (!canEscalateSection(issueCount, severity)) return;
            const escalateBtn = document.createElement('button');
            escalateBtn.className = 'section-download-btn alert';
            escalateBtn.innerHTML = '<i class="fas fa-bullhorn"></i>';
            escalateBtn.title = 'Передати контент-аналітику';
            escalateBtn.onclick = (event) => {
                event.stopPropagation();
                sendNotificationForSection(sectionTitle);
            };
            container.appendChild(escalateBtn);
        }

        function addSectionToggleListeners() {
            const sectionHeaders = document.querySelectorAll('.section-header');

            sectionHeaders.forEach(header => {
                if (header.closest('#picture-preview')) return;
                header.addEventListener('click', (e) => {
                    if (e.target.closest('.section-download-btn')) return;

                    const toggle = header.querySelector('.section-toggle');
                    const content = header.nextElementSibling;

                    if (toggle) toggle.classList.toggle('expanded');
                    if (content) content.classList.toggle('expanded');
                });
            });
        }

        function exportSectionReport(sectionTitle, data, type) {
            let reportText = `${sectionTitle}\n${'='.repeat(sectionTitle.length)}\n\n`;

            if (type === 'duplicate') {
                data.forEach(duplicate => {
                    reportText += `Дублікат значення: ${duplicate.value}\n`;
                    reportText += `Кількість товарів: ${duplicate.products.length}\n`;
                    reportText += `Товари: ${duplicate.products.join(', ')}\n\n`;
                });
            } else if (type === 'missing') {
                data.forEach(field => {
                    if (field.items.length > 0) {
                        reportText += `${field.name}: ${field.items.length} товарів\n`;
                        const items = field.items.map(item => typeof item === 'string' ? item : item.productId);
                        reportText += `Товари: ${items.join(', ')}\n\n`;
                    }
                });
            }

            const blob = new Blob([reportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${sectionTitle.replace(/\s+/g, '_')}_report.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>
