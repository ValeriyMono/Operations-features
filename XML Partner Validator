<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML Feed Validator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --primary-dark: #4338ca;
            --secondary: #0ea5e9;
            --accent: #f97316;
            --success: #22c55e;
            --warning: #eab308;
            --error: #ef4444;
            --neutral-50: #f9fafb;
            --neutral-100: #f3f4f6;
            --neutral-200: #e5e7eb;
            --neutral-300: #d1d5db;
            --neutral-400: #9ca3af;
            --neutral-500: #6b7280;
            --neutral-600: #4b5563;
            --neutral-700: #374151;
            --neutral-800: #1f2937;
            --neutral-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius-sm: 0.125rem;
            --radius: 0.25rem;
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
            --radius-xl: 0.75rem;
            --font-sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --transition: all 0.2s ease;
        }

        [data-theme="dark"] {
            --neutral-50: #111827;
            --neutral-100: #1f2937;
            --neutral-200: #374151;
            --neutral-300: #4b5563;
            --neutral-400: #6b7280;
            --neutral-500: #9ca3af;
            --neutral-600: #d1d5db;
            --neutral-700: #e5e7eb;
            --neutral-800: #f3f4f6;
            --neutral-900: #f9fafb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--neutral-100);
            color: var(--neutral-800);
            line-height: 1.5;
            min-height: 100vh;
            transition: var(--transition);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--neutral-300);
        }

        .app-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--neutral-600);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.5rem;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            color: var(--primary);
            background-color: var(--neutral-200);
        }

        .upload-container {
            background-color: var(--neutral-50);
            padding: 2rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
            text-align: center;
            transition: var(--transition);
        }

        .upload-container h2 {
            margin-bottom: 1rem;
            color: var(--neutral-800);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 1.5rem;
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background-color: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .file-input-button:hover {
            background-color: var(--primary-dark);
        }

        #file-name {
            margin-top: 0.5rem;
            color: var(--neutral-600);
            font-size: 0.875rem;
        }

        .progress-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            display: none;
        }

        .progress-bar {
            height: 0.5rem;
            background-color: var(--neutral-200);
            border-radius: var(--radius-xl);
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--neutral-600);
        }

        .validation-report {
            display: none;
            background-color: var(--neutral-50);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: var(--transition);
        }

        .report-header {
            background-color: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .report-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .report-actions {
            display: flex;
            gap: 1rem;
        }

        .report-action {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .report-action:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .report-summary {
            padding: 1.5rem;
            border-bottom: 1px solid var(--neutral-200);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .summary-card {
            background-color: white;
            padding: 1.25rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
        }

        .summary-card.error {
            border-left: 4px solid var(--error);
        }

        .summary-card.warning {
            border-left: 4px solid var(--warning);
        }

        .summary-card.success {
            border-left: 4px solid var(--success);
        }

        .summary-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-600);
            margin-bottom: 0.5rem;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--neutral-800);
        }

        .report-sections {
            padding: 1.5rem;
        }

        .report-section {
            margin-bottom: 1.5rem;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .section-header {
            padding: 1rem 1.5rem;
            background-color: var(--neutral-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .section-header:hover {
            background-color: var(--neutral-200);
        }

        .section-title {
            font-weight: 600;
            color: var(--neutral-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title .icon {
            color: var(--neutral-500);
        }

        .section-title .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--neutral-200);
            color: var(--neutral-700);
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .section-title .badge.error {
            background-color: #fee2e2;
            color: var(--error);
        }

        .section-title .badge.warning {
            background-color: #fef3c7;
            color: var(--warning);
        }

        .section-title .badge.success {
            background-color: #dcfce7;
            color: var(--success);
        }

        .section-toggle {
            color: var(--neutral-500);
            transition: transform 0.2s ease;
        }

        .section-toggle.expanded {
            transform: rotate(180deg);
        }

        .section-content {
            padding: 1.5rem;
            display: none;
            border-top: 1px solid var(--neutral-200);
        }

        .section-content.expanded {
            display: block;
        }

        .issue-list {
            list-style: none;
        }

        .issue-item {
            padding: 1rem;
            border-bottom: 1px solid var(--neutral-200);
        }

        .issue-item:last-child {
            border-bottom: none;
        }

        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .issue-title {
            font-weight: 500;
            color: var(--neutral-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .issue-icon {
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .issue-icon.error {
            background-color: #fee2e2;
            color: var(--error);
        }

        .issue-icon.warning {
            background-color: #fef3c7;
            color: var(--warning);
        }

        .issue-count {
            font-size: 0.875rem;
            color: var(--neutral-500);
        }

        .issue-details {
            background-color: var(--neutral-50);
            padding: 1rem;
            border-radius: var(--radius);
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .affected-items {
            margin-top: 0.75rem;
        }

        .affected-title {
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--neutral-700);
        }

        .affected-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .affected-item {
            background-color: var(--neutral-100);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius);
            font-size: 0.75rem;
            font-family: var(--font-mono);
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .result-table th {
            text-align: left;
            padding: 0.75rem 1rem;
            background-color: var(--neutral-100);
            border-bottom: 2px solid var(--neutral-200);
            color: var(--neutral-700);
            font-weight: 600;
        }

        .result-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--neutral-200);
            color: var(--neutral-700);
        }

        .result-table tr:last-child td {
            border-bottom: none;
        }

        .result-table tr:nth-child(even) {
            background-color: var(--neutral-50);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.error {
            background-color: var(--error);
        }

        .status-dot.warning {
            background-color: var(--warning);
        }

        .status-dot.success {
            background-color: var(--success);
        }

        footer {
            margin-top: 3rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--neutral-300);
            color: var(--neutral-500);
            font-size: 0.875rem;
            text-align: center;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .report-summary {
                grid-template-columns: 1fr;
            }

            .report-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .report-actions {
                width: 100%;
            }

            .section-header {
                padding: 0.75rem 1rem;
            }

            .section-content {
                padding: 1rem;
            }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="app-title">
                <i class="fas fa-check-double"></i>
                XML Feed Validator
            </div>
            <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
                <i class="fas fa-sun"></i>
            </button>
        </header>

        <div class="upload-container">
            <h2>Завантажте XML файл для валідації</h2>
            <div class="file-input-wrapper">
                <label class="file-input-button">
                    <i class="fas fa-upload"></i>
                    Вибрати файл
                    <input type="file" id="xml-file" class="file-input" accept=".xml">
                </label>
            </div>
            <div id="file-name"></div>
            <div class="progress-container" id="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">Аналіз файлу...</div>
            </div>
        </div>

        <div class="validation-report" id="validation-report">
            <div class="report-header">
                <h2 class="report-title">Звіт валідації</h2>
                <div class="report-actions">
                    <button class="report-action" id="export-report">
                        <i class="fas fa-download"></i>
                        Експорт
                    </button>
                    <button class="report-action" id="collapse-all">
                        <i class="fas fa-compress-alt"></i>
                        Згорнути все
                    </button>
                    <button class="report-action" id="expand-all">
                        <i class="fas fa-expand-alt"></i>
                        Розгорнути все
                    </button>
                </div>
            </div>

            <div class="report-summary" id="report-summary">
                <!-- Summary cards will be generated here -->
            </div>

            <div class="report-sections" id="report-sections">
                <!-- Report sections will be generated here -->
            </div>
        </div>

        <footer>
            <p>XML Feed Validator &copy; 2025</p>
        </footer>
    </div>

    <script>
        // Theme toggle functionality
        const themeToggle = document.getElementById('theme-toggle');
        const htmlElement = document.documentElement;
        
        // Check for saved theme preference or use user's system preference
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme) {
            htmlElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        } else if (prefersDark) {
            htmlElement.setAttribute('data-theme', 'dark');
            updateThemeIcon('dark');
        }
        
        themeToggle.addEventListener('click', () => {
            const currentTheme = htmlElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            htmlElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        });
        
        function updateThemeIcon(theme) {
            themeToggle.innerHTML = theme === 'dark' 
                ? '<i class="fas fa-sun"></i>' 
                : '<i class="fas fa-moon"></i>';
        }

        // File handling
        const fileInput = document.getElementById('xml-file');
        const fileNameDisplay = document.getElementById('file-name');
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const validationReport = document.getElementById('validation-report');
        const reportSummary = document.getElementById('report-summary');
        const reportSections = document.getElementById('report-sections');
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                fileNameDisplay.textContent = file.name;
                progressContainer.style.display = 'block';
                progressFill.style.width = '0%';
                progressText.textContent = 'Аналіз файлу...';
                
                // Start validation process
                validateXMLFile(file);
            }
        });

        // Report export functionality
        document.getElementById('export-report').addEventListener('click', exportReport);
        
        // Collapse/Expand functionality
        document.getElementById('collapse-all').addEventListener('click', () => toggleAllSections(false));
        document.getElementById('expand-all').addEventListener('click', () => toggleAllSections(true));
        
        function toggleAllSections(expand) {
            const sections = document.querySelectorAll('.report-section');
            sections.forEach(section => {
                const toggle = section.querySelector('.section-toggle');
                const content = section.querySelector('.section-content');
                
                if (expand) {
                    toggle.classList.add('expanded');
                    content.classList.add('expanded');
                } else {
                    toggle.classList.remove('expanded');
                    content.classList.remove('expanded');
                }
            });
        }

        function exportReport() {
            // Generate report text
            let reportText = "XML Feed Validation Report\n";
            reportText += "=========================\n\n";
            
            // Add summary
            const summaryCards = document.querySelectorAll('.summary-card');
            reportText += "Summary:\n";
            summaryCards.forEach(card => {
                const title = card.querySelector('.summary-title').textContent;
                const value = card.querySelector('.summary-value').textContent;
                reportText += `${title}: ${value}\n`;
            });
            reportText += "\n";
            
            // Add detailed sections
            const sections = document.querySelectorAll('.report-section');
            sections.forEach(section => {
                const title = section.querySelector('.section-title').textContent.trim();
                reportText += `${title}\n${'-'.repeat(title.length)}\n\n`;
                
                const issueItems = section.querySelectorAll('.issue-item');
                issueItems.forEach(item => {
                    const issueTitle = item.querySelector('.issue-title').textContent.trim();
                    const issueCount = item.querySelector('.issue-count')?.textContent.trim() || '';
                    
                    reportText += `* ${issueTitle} ${issueCount}\n`;
                    
                    const affectedTitle = item.querySelector('.affected-title');
                    if (affectedTitle) {
                        reportText += `  ${affectedTitle.textContent.trim()}\n`;
                        
                        const affectedItems = item.querySelectorAll('.affected-item');
                        affectedItems.forEach(affectedItem => {
                            reportText += `    - ${affectedItem.textContent.trim()}\n`;
                        });
                    }
                    
                    reportText += "\n";
                });
            });
            
            // Create and download file
            const blob = new Blob([reportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'validation-report.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // XML Validation Functions
        async function validateXMLFile(file) {
            const fileReader = new FileReader();
            
            fileReader.onload = async function(event) {
                try {
                    // Update progress
                    updateProgress(10, 'Розбір XML...');
                    
                    // Parse XML
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(event.target.result, "text/xml");
                    
                    // Check for parsing errors
                    const parseError = xmlDoc.getElementsByTagName('parsererror');
                    if (parseError.length > 0) {
                        throw new Error('Invalid XML format');
                    }
                    
                    // Update progress
                    updateProgress(30, 'Аналіз товарів...');
                    
                    // Get all offers
                    const offers = xmlDoc.getElementsByTagName('offer');
                    const totalProducts = offers.length;
                    
                    // Prepare validation results object
                    const results = {
                        totalProducts,
                        duplicateCodes: [],
                        duplicateIds: [],
                        duplicateVendorCodes: [],
                        duplicateBarcodes: [],
                        missingTitles: [],
                        duplicateTitles: [],
                        missingCategories: [],
                        invalidBrands: [],
                        missingDimensions: {
                            weight: [],
                            height: [],
                            width: [],
                            length: []
                        },
                        invalidTags: [],
                        poorDescriptions: []
                    };
                    
                    // Track unique values
                    const uniqueValues = {
                        codes: new Map(),
                        ids: new Map(),
                        vendorCodes: new Map(),
                        titles: new Map(),
                        barcodes: new Map()
                    };
                    
                    // Update progress
                    updateProgress(50, 'Валідація товарів...');
                    
                    // Process each offer
                    for (let i = 0; i < offers.length; i++) {
                        const offer = offers[i];
                        
                        // Get product ID for reference
                        const productId = getElementTextContent(offer, 'id');
                        
                        // Check code uniqueness
                        checkUniqueness(offer, 'code', productId, uniqueValues.codes, results.duplicateCodes);
                        
                        // Check ID uniqueness
                        checkUniqueness(offer, 'id', productId, uniqueValues.ids, results.duplicateIds);
                        
                        // Check vendor_code uniqueness
                        checkUniqueness(offer, 'vendor_code', productId, uniqueValues.vendorCodes, results.duplicateVendorCodes);
                        
                        // Check barcode uniqueness
                        checkUniqueness(offer, 'barcode', productId, uniqueValues.barcodes, results.duplicateBarcodes);
                        
                        // Check title presence and uniqueness
                        const titleElement = offer.getElementsByTagName('title')[0];
                        if (!titleElement || !titleElement.textContent.trim()) {
                            results.missingTitles.push(productId);
                        } else {
                            checkUniqueness(offer, 'title', productId, uniqueValues.titles, results.duplicateTitles);
                        }
                        
                        // Check category presence
                        const categoryElement = offer.getElementsByTagName('category')[0];
                        if (!categoryElement || !categoryElement.textContent.trim()) {
                            results.missingCategories.push(productId);
                        }
                        
                        // Check brand for "&" symbol
                        const brandElement = offer.getElementsByTagName('brand')[0];
                        if (brandElement && brandElement.textContent.includes('&') && 
                            !brandElement.textContent.includes('&amp;')) {
                            results.invalidBrands.push(productId);
                        }
                        
                        // Check dimensions
                        checkDimensionPresence(offer, 'weight', productId, results.missingDimensions.weight);
                        checkDimensionPresence(offer, 'height', productId, results.missingDimensions.height);
                        checkDimensionPresence(offer, 'width', productId, results.missingDimensions.width);
                        checkDimensionPresence(offer, 'length', productId, results.missingDimensions.length);
                        
                        // Check tags structure
                        const tagsElement = offer.getElementsByTagName('tags')[0];
                        if (tagsElement) {
                            // Check if tags are properly closed
                            const tagsHtml = new XMLSerializer().serializeToString(tagsElement);
                            if (!tagsHtml.includes('</tags>')) {
                                results.invalidTags.push(productId);
                            }
                        }
                        
                        // Check description formatting
                        const descriptionElement = offer.getElementsByTagName('description')[0];
                        if (descriptionElement) {
                            const descContent = descriptionElement.textContent.trim();
                            if (descContent && (!descContent.includes('<h5') && 
                                               !descContent.includes('<p>') && 
                                               !descContent.includes('<li>') && 
                                               !descContent.includes('<ul>') && 
                                               !descContent.includes('<br>'))) {
                                results.poorDescriptions.push(productId);
                            }
                        }
                        
                        // Update progress for each 10% of products
                        if (i % Math.ceil(offers.length / 10) === 0) {
                            const progress = 50 + Math.floor((i / offers.length) * 40);
                            updateProgress(progress, `Проаналізовано ${i}/${offers.length} товарів...`);
                        }
                    }
                    
                    // Update progress
                    updateProgress(90, 'Генерація звіту...');
                    
                    // Generate validation report
                    generateValidationReport(results);
                    
                    // Complete
                    updateProgress(100, 'Аналіз завершено');
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 1000);
                    
                } catch (error) {
                    console.error('Validation error:', error);
                    progressText.textContent = `Помилка: ${error.message}`;
                    progressFill.style.width = '100%';
                    progressFill.style.backgroundColor = 'var(--error)';
                }
            };
            
            fileReader.readAsText(file);
        }
        
        function getElementTextContent(parentElement, tagName) {
            const element = parentElement.getElementsByTagName(tagName)[0];
            return element ? element.textContent.trim() : '';
        }
        
        function checkUniqueness(offer, tagName, productId, uniqueMap, resultArray) {
            const element = offer.getElementsByTagName(tagName)[0];
            if (element && element.textContent.trim()) {
                const value = element.textContent.trim();
                
                if (uniqueMap.has(value)) {
                    // This is a duplicate
                    const duplicateInfo = uniqueMap.get(value);
                    duplicateInfo.count++;
                    duplicateInfo.products.push(productId);
                    
                    // Check if this duplicate is already recorded
                    const existingDuplicate = resultArray.find(d => d.value === value);
                    if (existingDuplicate) {
                        existingDuplicate.products.push(productId);
                    } else {
                        resultArray.push({
                            value,
                            products: [duplicateInfo.firstProduct, productId],
                            count: duplicateInfo.count
                        });
                    }
                } else {
                    // First occurrence
                    uniqueMap.set(value, {
                        firstProduct: productId,
                        count: 1,
                        products: [productId]
                    });
                }
            }
        }
        
        function checkDimensionPresence(offer, dimensionName, productId, resultArray) {
            const element = offer.getElementsByTagName(dimensionName)[0];
            if (!element || !element.textContent.trim()) {
                resultArray.push(productId);
            }
        }
        
        function updateProgress(percentage, text) {
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = text;
        }
        
        function generateValidationReport(results) {
            // Show the report container
            validationReport.style.display = 'block';
            
            // Clear previous report
            reportSummary.innerHTML = '';
            reportSections.innerHTML = '';
            
            // Generate summary cards
            generateSummaryCards(results);
            
            // Generate detailed sections
            generateDuplicateSection('code', 'Дублікати кодів', results.duplicateCodes);
            generateDuplicateSection('id', 'Дублікати ID', results.duplicateIds);
            generateDuplicateSection('vendor_code', 'Дублікати вендор-кодів', results.duplicateVendorCodes);
            generateDuplicateSection('barcode', 'Дублікати штрих-кодів', results.duplicateBarcodes);
            generateDuplicateSection('title', 'Дублікати назв', results.duplicateTitles);
            
            // Generate missing fields section
            const missingFields = [
                { name: 'Відсутні назви', items: results.missingTitles },
                { name: 'Відсутні категорії', items: results.missingCategories },
                { name: 'Відсутня вага', items: results.missingDimensions.weight },
                { name: 'Відсутня висота', items: results.missingDimensions.height },
                { name: 'Відсутня ширина', items: results.missingDimensions.width },
                { name: 'Відсутня довжина', items: results.missingDimensions.length }
            ];
            
            generateMissingFieldsSection('Відсутні обов\'язкові поля', missingFields);
            
            // Generate formatting issues section
            const formattingIssues = [
                { name: 'Некоректний символ & в бренді', items: results.invalidBrands },
                { name: 'Некоректні теги tags', items: results.invalidTags },
                { name: 'Опис без HTML форматування', items: results.poorDescriptions }
            ];
            
            generateMissingFieldsSection('Проблеми форматування', formattingIssues);
            
            // Add event listeners to section headers
            addSectionToggleListeners();
            
            // Expand first section by default
            const firstSection = document.querySelector('.report-section');
            if (firstSection) {
                const toggle = firstSection.querySelector('.section-toggle');
                const content = firstSection.querySelector('.section-content');
                toggle.classList.add('expanded');
                content.classList.add('expanded');
            }
        }
        
        function generateSummaryCards(results) {
            // Count total issues
            const totalIssues = countTotalIssues(results);
            
            // Add total products card
            addSummaryCard('Усього товарів', results.totalProducts, 'success');
            
            // Add issues card
            const severity = totalIssues > 0 ? 'error' : 'success';
            addSummaryCard('Проблеми', totalIssues, severity);
            
            // Add duplicate values card
            const totalDuplicates = results.duplicateCodes.length + 
                                   results.duplicateIds.length + 
                                   results.duplicateVendorCodes.length +
                                   results.duplicateBarcodes.length +
                                   results.duplicateTitles.length;
            
            const duplicateSeverity = totalDuplicates > 0 ? 'error' : 'success';
            addSummaryCard('Дублікати', totalDuplicates, duplicateSeverity);
            
            // Add missing fields card
            const totalMissing = results.missingTitles.length + 
                               results.missingCategories.length +
                               results.missingDimensions.weight.length +
                               results.missingDimensions.height.length +
                               results.missingDimensions.width.length +
                               results.missingDimensions.length.length;
            
            const missingSeverity = totalMissing > 0 ? 'warning' : 'success';
            addSummaryCard('Відсутні поля', totalMissing, missingSeverity);
        }
        
        function countTotalIssues(results) {
            return results.duplicateCodes.length + 
                   results.duplicateIds.length + 
                   results.duplicateVendorCodes.length +
                   results.duplicateBarcodes.length +
                   results.duplicateTitles.length +
                   results.missingTitles.length + 
                   results.missingCategories.length +
                   results.invalidBrands.length +
                   results.invalidTags.length +
                   results.poorDescriptions.length +
                   results.missingDimensions.weight.length +
                   results.missingDimensions.height.length +
                   results.missingDimensions.width.length +
                   results.missingDimensions.length.length;
        }
        
        function addSummaryCard(title, value, type) {
            const card = document.createElement('div');
            card.className = `summary-card ${type}`;
            
            const titleElement = document.createElement('div');
            titleElement.className = 'summary-title';
            titleElement.textContent = title;
            
            const valueElement = document.createElement('div');
            valueElement.className = 'summary-value';
            valueElement.textContent = value;
            
            card.appendChild(titleElement);
            card.appendChild(valueElement);
            
            reportSummary.appendChild(card);
        }
        
        function generateDuplicateSection(fieldName, sectionTitle, duplicates) {
            if (duplicates.length === 0) return;
            
            const section = createSection(sectionTitle, 'fa-clone', duplicates.length, 'error');
            const content = section.querySelector('.section-content');
            
            // Create issue list
            const issueList = document.createElement('ul');
            issueList.className = 'issue-list';
            
            duplicates.forEach(duplicate => {
                const issueItem = document.createElement('li');
                issueItem.className = 'issue-item';
                
                const issueHeader = document.createElement('div');
                issueHeader.className = 'issue-header';
                
                const issueTitle = document.createElement('div');
                issueTitle.className = 'issue-title';
                
                const issueIcon = document.createElement('span');
                issueIcon.className = 'issue-icon error';
                issueIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
                
                issueTitle.appendChild(issueIcon);
                issueTitle.appendChild(document.createTextNode(`Дублікат значення: ${duplicate.value}`));
                
                const issueCount = document.createElement('div');
                issueCount.className = 'issue-count';
                issueCount.textContent = `${duplicate.products.length} товарів`;
                
                issueHeader.appendChild(issueTitle);
                issueHeader.appendChild(issueCount);
                
                const issueDetails = document.createElement('div');
                issueDetails.className = 'issue-details';
                
                const affectedItems = document.createElement('div');
                affectedItems.className = 'affected-items';
                
                const affectedTitle = document.createElement('div');
                affectedTitle.className = 'affected-title';
                affectedTitle.textContent = 'Товари з цим значенням:';
                
                const affectedList = document.createElement('div');
                affectedList.className = 'affected-list';
                
                duplicate.products.forEach(productId => {
                    const affectedItem = document.createElement('span');
                    affectedItem.className = 'affected-item';
                    affectedItem.textContent = productId;
                    affectedList.appendChild(affectedItem);
                });
                
                affectedItems.appendChild(affectedTitle);
                affectedItems.appendChild(affectedList);
                
                issueDetails.appendChild(affectedItems);
                
                issueItem.appendChild(issueHeader);
                issueItem.appendChild(issueDetails);
                
                issueList.appendChild(issueItem);
            });
            
            content.appendChild(issueList);
            reportSections.appendChild(section);
        }
        
        function generateMissingFieldsSection(sectionTitle, fields) {
            // Count total items
            let totalItems = 0;
            fields.forEach(field => {
                totalItems += field.items.length;
            });
            
            if (totalItems === 0) return;
            
            const section = createSection(sectionTitle, 'fa-exclamation-triangle', totalItems, 'warning');
            const content = section.querySelector('.section-content');
            
            // Create issue list
            const issueList = document.createElement('ul');
            issueList.className = 'issue-list';
            
            fields.forEach(field => {
                if (field.items.length === 0) return;
                
                const issueItem = document.createElement('li');
                issueItem.className = 'issue-item';
                
                const issueHeader = document.createElement('div');
                issueHeader.className = 'issue-header';
                
                const issueTitle = document.createElement('div');
                issueTitle.className = 'issue-title';
                
                const issueIcon = document.createElement('span');
                issueIcon.className = 'issue-icon warning';
                issueIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                
                issueTitle.appendChild(issueIcon);
                issueTitle.appendChild(document.createTextNode(field.name));
                
                const issueCount = document.createElement('div');
                issueCount.className = 'issue-count';
                issueCount.textContent = `${field.items.length} товарів`;
                
                issueHeader.appendChild(issueTitle);
                issueHeader.appendChild(issueCount);
                
                const issueDetails = document.createElement('div');
                issueDetails.className = 'issue-details';
                
                const affectedItems = document.createElement('div');
                affectedItems.className = 'affected-items';
                
                const affectedTitle = document.createElement('div');
                affectedTitle.className = 'affected-title';
                affectedTitle.textContent = 'Проблемні товари:';
                
                const affectedList = document.createElement('div');
                affectedList.className = 'affected-list';
                
                field.items.forEach(productId => {
                    const affectedItem = document.createElement('span');
                    affectedItem.className = 'affected-item';
                    affectedItem.textContent = productId;
                    affectedList.appendChild(affectedItem);
                });
                
                affectedItems.appendChild(affectedTitle);
                affectedItems.appendChild(affectedList);
                
                issueDetails.appendChild(affectedItems);
                
                issueItem.appendChild(issueHeader);
                issueItem.appendChild(issueDetails);
                
                issueList.appendChild(issueItem);
            });
            
            content.appendChild(issueList);
            reportSections.appendChild(section);
        }
        
        function createSection(title, iconClass, count, type) {
            const section = document.createElement('div');
            section.className = 'report-section';
            
            const header = document.createElement('div');
            header.className = 'section-header';
            
            const sectionTitle = document.createElement('div');
            sectionTitle.className = 'section-title';
            
            const icon = document.createElement('i');
            icon.className = `fas ${iconClass} icon`;
            
            sectionTitle.appendChild(icon);
            sectionTitle.appendChild(document.createTextNode(title));
            
            if (count > 0) {
                const badge = document.createElement('span');
                badge.className = `badge ${type}`;
                badge.textContent = count;
                sectionTitle.appendChild(badge);
            }
            
            const toggle = document.createElement('div');
            toggle.className = 'section-toggle';
            toggle.innerHTML = '<i class="fas fa-chevron-down"></i>';
            
            header.appendChild(sectionTitle);
            header.appendChild(toggle);
            
            const content = document.createElement('div');
            content.className = 'section-content';
            
            section.appendChild(header);
            section.appendChild(content);
            
            return section;
        }
        
        function addSectionToggleListeners() {
            const sectionHeaders = document.querySelectorAll('.section-header');
            
            sectionHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const toggle = header.querySelector('.section-toggle');
                    const content = header.nextElementSibling;
                    
                    toggle.classList.toggle('expanded');
                    content.classList.toggle('expanded');
                });
            });
        }
    </script>
</body>
</html>
